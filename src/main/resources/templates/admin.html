<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fashion Shop Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/admin.css}" />
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo">
            <h2>Fashion Shop</h2>
        </div>
        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-section="dashboard">
                <span class="icon">üìä</span> Dashboard
            </a>
            <a href="#" class="nav-item" data-section="users">
                <span class="icon">üë•</span> Users
            </a>
            <a href="#" class="nav-item" data-section="analytics">
                <span class="icon">üìà</span> Analytics
            </a>
            <a href="#" class="nav-item" data-section="auditlog">
                <span class="icon">üìã</span> Audit Log
            </a>
            <a href="#" class="nav-item" data-section="blogs">
                <span class="icon">üìù</span> Blogs
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                <div class="header-title-section">
                    <h1 id="pageTitle">Dashboard</h1>
                    <p class="header-subtitle" id="headerSubtitle">
                        Welcome back, Admin
                    </p>
                </div>
            </div>
            <div class="header-right">
                <div class="status-info">
                    <div class="status-item">
                        <span class="status-label">Active Users</span>
                        <span class="status-value" id="headerActiveUsers">0</span>
                    </div>
                    <div class="status-divider"></div>
                    <div class="status-item">
                        <span class="status-label">Total Users</span>
                        <span class="status-value" id="headerTotalUsers">0</span>
                    </div>
                </div>
                <div class="notifications">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="bell-icon">üîî</i>
                        <span class="notification-badge">3</span>
                    </button>
                </div>
                <div class="user-profile">
                    <div class="avatar">A</div>
                    <div class="user-info">
                        <span class="user-name">Admin</span>
                        <span class="user-role">Administrator</span>
                    </div>
                    <div class="profile-dropdown">
                        <button class="dropdown-toggle">‚ãÆ</button>
                        <div class="dropdown-menu">
                            <a href="profile/view" class="dropdown-item"> <i>üë§</i> Profile </a>
                            <div class="dropdown-divider"></div>
                            <form th:action="@{/logout}" method="post" style="margin: 0">
                                <button type="submit" class="dropdown-item logout-item">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon red">üë•</div>
                    <div class="stat-info">
                        <h3>Total Users</h3>
                        <p class="stat-value" id="totalUsersStat">0</p>
                        <span class="stat-change">All registered accounts</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <h3>Active Users</h3>
                        <p class="stat-value" id="activeUsersStat">0</p>
                        <span class="stat-change positive">Can log in & use system</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚õî</div>
                    <div class="stat-info">
                        <h3>Inactive Users</h3>
                        <p class="stat-value" id="inactiveUsersStat">0</p>
                        <span class="stat-change warning">Locked / deactivated</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üëë</div>
                    <div class="stat-info">
                        <h3>Admin & Staff</h3>
                        <p class="stat-value" id="adminStaffStat">0 admin / 0 staff</p>
                        <span class="stat-change info">Privileged accounts</span>
                    </div>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Recent Orders</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable">
                                <tr>
                                    <td>#ORD-001</td>
                                    <td>John Doe</td>
                                    <td>$125.00</td>
                                    <td><span class="badge success">Purchased</span></td>
                                </tr>
                                <tr>
                                    <td>#ORD-002</td>
                                    <td>Jane Smith</td>
                                    <td>$89.50</td>
                                    <td><span class="badge warning">Pending</span></td>
                                </tr>
                                <tr>
                                    <td>#ORD-003</td>
                                    <td>Mike Johnson</td>
                                    <td>$245.00</td>
                                    <td><span class="badge warning">Pending</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3>Top Products</h3>
                    <div class="product-list">
                        <div class="product-item">
                            <span class="product-name">Classic T-Shirt</span>
                            <span class="product-sales">245 sales</span>
                        </div>
                        <div class="product-item">
                            <span class="product-name">Denim Jeans</span>
                            <span class="product-sales">198 sales</span>
                        </div>
                        <div class="product-item">
                            <span class="product-name">Leather Jacket</span>
                            <span class="product-sales">156 sales</span>
                        </div>
                        <div class="product-item">
                            <span class="product-name">Summer Dress</span>
                            <span class="product-sales">143 sales</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="users" class="content-section">
            <div class="section-header">
                <h2>Users Management</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="search-bar" style="margin: 0;">
                        <input type="text" placeholder="Search users by name, email..." id="userSearchInput" />
                        <i class="search-icon">üîç</i>
                    </div>
                    <button class="btn btn-primary" id="addUserBtn">+ Add User</button>
                </div>
            </div>
            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr th:each="user : ${users}" th:data-role="${user.role.code}"
                                th:data-active="${user.active}">
                                <td th:text="${user.id}"></td>
                                <td th:text="${user.fullName}"></td>
                                <td th:text="${user.email}"></td>
                                <td>
                                    <div th:if="${user.role.code != 'ROLE_ADMIN'}">
                                        <select class="role-select form-control input-sm"
                                            th:disabled="${user.id == currentUserId}"
                                            th:data-original-value="${user.role.code}"
                                            onfocus="this.setAttribute('data-original-value', this.value)"
                                            th:onchange="'updateUserRole(' + ${user.id} + ', this)'">
                                            <option th:each="role : ${roles}" th:value="${role.code}"
                                                th:text="${role.name}" th:selected="${user.role.code == role.code}">
                                            </option>
                                        </select>
                                    </div>

                                    <span th:if="${user.role.code == 'ROLE_ADMIN'}" class="badge admin"
                                        th:text="${user.role.name}"></span>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="${user.active ? 'success' : 'danger'}"
                                        th:text="${user.active ? 'Active' : 'Inactive'}"></span>
                                </td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn btn-sm btn-secondary"
                                            th:onclick="'viewUser(' + ${user.id} + ')'">
                                            View
                                        </button>

                                        <button class="btn btn-sm btn-secondary"
                                            th:onclick="'editUser(' + ${user.id} + ')'"
                                            th:if="${user.id != currentUserId and user.role.code != 'ROLE_ADMIN'}">
                                            Edit
                                        </button>

                                        <button th:if="${user.role.code != 'ROLE_ADMIN'}" class="btn btn-sm"
                                            th:classappend="${user.active ? 'btn-danger' : 'btn-success'}"
                                            th:onclick="'toggleUserStatus(' + ${user.id} + ', this)'"
                                            th:disabled="${user.id == currentUserId}">
                                            <span th:text="${user.active ? 'Deactivate' : 'Activate'}"></span>
                                        </button>

                                        <button th:if="${!user.active and user.role.code != 'ROLE_ADMIN'}"
                                            class="btn btn-sm btn-danger btn-delete"
                                            th:onclick="'deleteUser(' + ${user.id} + ', this)'">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="content-section">
            <div class="section-header">
                <h2>Analytics</h2>
                <div class="filter-group">
                    <label style="font-size: 14px; color: #6b7280;">Range:</label>
                    <select class="filter-select" id="analyticsDays">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
            </div>
            <div class="analytics-grid">
                <div class="card">
                    <h3>Sales Overview</h3>
                    <div class="stats-grid">
                        <div class="stat-card small">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <h4>Total Revenue</h4>
                                <p class="stat-value" id="analyticsTotalRevenue">0</p>
                                <span class="stat-change">PAID orders</span>
                            </div>
                        </div>
                        <div class="stat-card small">
                            <div class="stat-icon">üßæ</div>
                            <div class="stat-info">
                                <h4>Total Orders</h4>
                                <p class="stat-value" id="analyticsTotalOrders">0</p>
                                <span class="stat-change">All time</span>
                            </div>
                        </div>
                        <div class="stat-card small">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-info">
                                <h4>Completed Orders</h4>
                                <p class="stat-value" id="analyticsCompletedOrders">0</p>
                                <span class="stat-change positive">Paid / Confirmed / Delivered</span>
                            </div>
                        </div>
                        <div class="stat-card small">
                            <div class="stat-icon">‚è≥</div>
                            <div class="stat-info">
                                <h4>Pending / Cancelled</h4>
                                <p class="stat-value" id="analyticsPendingCancelled">0 / 0</p>
                                <span class="stat-change warning">Need attention</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-placeholder" id="salesChartContainer">
                        <p style="margin-bottom: 4px;">üìà Revenue by day</p>
                        <p class="chart-note" id="salesChartNote">
                            Loading analytics data...
                        </p>
                        <div id="salesChartLine" class="sales-line-chart"></div>
                    </div>
                </div>
                <div class="card">
                    <h3>Category Distribution</h3>
                    <div id="categoryStats" class="category-stats">
                        <!-- Filled by JS from analytics API -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Audit Log Section -->
        <section id="auditlog" class="content-section">
            <div class="section-header">
                <h2>Audit Log</h2>
                <div class="filter-group">
                    <select class="filter-select" id="auditAction">
                        <option value="all">All Actions</option>
                        <option value="CREATE">Create</option>
                        <option value="UPDATE">Update</option>
                        <option value="DELETE">Delete</option>
                        <option value="VIEW">View</option>
                    </select>
                    <select class="filter-select" id="auditEntity">
                        <option value="all">All Entities</option>
                        <option value="Product">Product</option>
                        <option value="Brand">Brand</option>
                        <option value="Order">Order</option>
                        <option value="User">User</option>
                    </select>
                    <input type="date" class="filter-select" id="auditDate" />
                    <button class="btn btn-secondary" onclick="clearAuditFilters()">Clear Filters</button>
                </div>
            </div>
            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Actor</th>
                                <th>Role</th>
                                <th>Action</th>
                                <th>Entity</th>
                                <th>Changes</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr th:each="log : ${auditLogs}" 
                                th:data-action="${log.action}"
                                th:data-entity="${log.entity}"
                                th:data-date="${#temporals.format(log.createdAt, 'yyyy-MM-dd')}">
                                <td th:text="${log.id}"></td>
                                <td th:text="${log.actor != null ? log.actor.fullName : 'System'}"></td>
                                <td th:text="${log.actorRole}"></td>
                                <td>
                                    <span class="badge"
                                        th:classappend="${log.action == 'CREATE' ? 'success' : (log.action == 'DELETE' ? 'danger' : (log.action == 'UPDATE' ? 'warning' : 'info'))}"
                                        th:text="${log.action}"></span>
                                </td>
                                <td th:text="${log.entity}"></td>
                                <td>
                                    <span class="changes-preview"
                                    th:utext="${#strings.abbreviate(log.getChangesDisplay(), 100)}"
                                    th:title="${log.changes}"></span>
                                </td>
                                <td th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Blogs Section -->
        <section id="blogs" class="content-section">
            <div style="display: flex; gap: 20px; min-height: calc(100vh - 200px);">
                <!-- Left Sidebar - Status Filter -->
                <aside style="width: 250px; background: #f8f9fa; border-radius: 8px; padding: 20px; height: fit-content; position: sticky; top: 20px;">
                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Posts</h3>
                    <nav style="display: flex; flex-direction: column; gap: 8px;">
                        <a th:href="@{/admin(tab='blogs')}" 
                           th:classappend="${currentBlogStatus == null or currentBlogStatus == ''} ? 'blog-filter-active'"
                           style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='transparent'">
                            <span>All</span>
                            <span style="background: #dee2e6; padding: 2px 8px; border-radius: 12px; font-size: 12px;" 
                                  th:text="${totalBlogs}">0</span>
                        </a>
                        <a th:href="@{/admin(tab='blogs', status='PUBLISHED')}" 
                           th:classappend="${currentBlogStatus == 'PUBLISHED'} ? 'blog-filter-active'"
                           style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='transparent'">
                            <span>Published</span>
                            <span style="background: #dee2e6; padding: 2px 8px; border-radius: 12px; font-size: 12px;" 
                                  th:text="${publishedCount}">0</span>
                        </a>
                        <a th:href="@{/admin(tab='blogs', status='DRAFT')}" 
                           th:classappend="${currentBlogStatus == 'DRAFT'} ? 'blog-filter-active'"
                           style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='transparent'">
                            <span>Draft</span>
                            <span style="background: #dee2e6; padding: 2px 8px; border-radius: 12px; font-size: 12px;" 
                                  th:text="${draftCount}">0</span>
                        </a>
                        <a th:href="@{/admin(tab='blogs', status='PENDING_REVIEW')}" 
                           th:classappend="${currentBlogStatus == 'PENDING_REVIEW'} ? 'blog-filter-active'"
                           style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='transparent'">
                            <span>Pending</span>
                            <span style="background: #dee2e6; padding: 2px 8px; border-radius: 12px; font-size: 12px;" 
                                  th:text="${pendingCount}">0</span>
                        </a>
                        <a th:href="@{/admin(tab='blogs', status='ARCHIVED')}" 
                           th:classappend="${currentBlogStatus == 'ARCHIVED'} ? 'blog-filter-active'"
                           style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='transparent'">
                            <span>Archived</span>
                            <span style="background: #dee2e6; padding: 2px 8px; border-radius: 12px; font-size: 12px;" 
                                  th:text="${archivedCount}">0</span>
                        </a>
                        <a th:href="@{/admin(tab='blogs', status='PENDING_DELETE')}" 
                           th:classappend="${currentBlogStatus == 'PENDING_DELETE'} ? 'blog-filter-active'"
                           style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='transparent'">
                            <span>Pending Delete</span>
                            <span style="background: #dee2e6; padding: 2px 8px; border-radius: 12px; font-size: 12px;" 
                                  th:text="${pendingDeleteCount}">0</span>
                        </a>
                    </nav>
                </aside>

                <!-- Main Content Area -->
                <div style="flex: 1;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">All posts</h2>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <form method="get" th:action="@{/admin}" style="flex: 1; display: flex; gap: 12px;">
                            <input type="hidden" name="tab" value="blogs">
                            <input type="hidden" name="status" th:value="${currentBlogStatus}">
                            <input type="text" name="keyword" 
                                   th:value="${blogKeyword}"
                                   placeholder="Search by title" 
                                   style="flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <select name="category" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="">All categories</option>
                                <option value="TRENDS">TRENDS</option>
                                <option value="STYLE TIPS">STYLE TIPS</option>
                                <option value="ACCESSORIES">ACCESSORIES</option>
                                <option value="INSPIRATION">INSPIRATION</option>
                                <option value="SEASONAL">SEASONAL</option>
                                <option value="BEAUTY">BEAUTY</option>
                            </select>
                            <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Search</button>
                        </form>
                    </div>

                    <!-- Blog Posts List - Card Layout -->
                    <div id="blogsList" style="display: flex; flex-direction: column; gap: 16px;">
                        <div th:each="blog : ${blogs}" 
                             th:id="'blog-card-' + ${blog.id}"
                             style="display: flex; gap: 16px; background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; transition: box-shadow 0.2s;"
                             onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
                             onmouseout="this.style.boxShadow='none'">
                            <!-- Thumbnail -->
                            <div style="width: 120px; height: 80px; background: #f8f9fa; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                                <img th:if="${blog.imageUrl != null and !blog.imageUrl.isEmpty()}" 
                                     th:src="${blog.imageUrl}" 
                                     alt="Blog thumbnail"
                                     style="width: 100%; height: 100%; object-fit: cover;">
                                <div th:if="${blog.imageUrl == null or blog.imageUrl.isEmpty()}" 
                                     style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #adb5bd; font-size: 24px;">
                                    üìù
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span class="badge" 
                                              th:classappend="${blog.status.name() == 'PUBLISHED' ? 'success' : 
                                                              (blog.status.name() == 'PENDING_REVIEW' ? 'warning' : 
                                                              (blog.status.name() == 'PENDING_DELETE' ? 'danger' :
                                                              (blog.status.name() == 'DRAFT' ? 'info' : 
                                                              (blog.status.name() == 'ARCHIVED' ? 'secondary' : 'danger'))))}"
                                              th:text="${blog.status}"
                                              style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">
                                        </span>
                                        <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #212529;">
                                            <span th:text="${blog.title}"></span>
                                        </h3>
                                        <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 13px;">
                                            <span th:text="${blog.author}"></span>
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; margin-left: 16px; flex-wrap: wrap;">
                                        <a th:href="@{/admin/blog/view/{id}(id=${blog.id})}"
                                           style="padding: 6px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; text-decoration: none; display: inline-block;">
                                            VIEW
                                        </a>
                                        <button type="button" 
                                                th:if="${blog.status.name() == 'PENDING_REVIEW'}"
                                                class="btn btn-sm btn-success"
                                                th:onclick="'approveBlog(' + ${blog.id} + ', this)'"
                                                style="padding: 6px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            APPROVE
                                        </button>
                                        <button type="button" 
                                                th:if="${blog.status.name() == 'PENDING_REVIEW'}"
                                                class="btn btn-sm btn-danger"
                                                th:onclick="'rejectBlog(' + ${blog.id} + ', this)'"
                                                style="padding: 6px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            REJECT
                                        </button>
                                        <button type="button" 
                                                th:if="${blog.status.name() == 'PUBLISHED'}"
                                                class="btn btn-sm btn-warning"
                                                th:onclick="'archiveBlog(' + ${blog.id} + ', this)'"
                                                style="padding: 6px 16px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            ARCHIVE
                                        </button>
                                        <button type="button" 
                                                th:if="${blog.status.name() == 'ARCHIVED'}"
                                                class="btn btn-sm btn-success"
                                                th:onclick="'unarchiveBlog(' + ${blog.id} + ', this)'"
                                                style="padding: 6px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            UNARCHIVE
                                        </button>
                                        <button type="button" 
                                                th:if="${blog.status.name() == 'PENDING_DELETE'}"
                                                class="btn btn-sm btn-danger"
                                                th:onclick="'approveDelete(' + ${blog.id} + ', this)'"
                                                style="padding: 6px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            APPROVE DELETE
                                        </button>
                                        <button type="button" 
                                                th:if="${blog.status.name() == 'PENDING_DELETE'}"
                                                class="btn btn-sm btn-success"
                                                th:onclick="'rejectDelete(' + ${blog.id} + ', this)'"
                                                style="padding: 6px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            REJECT DELETE
                                        </button>
                                    </div>
                                </div>
                                <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 13px; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;"
                                   th:text="${blog.excerpt}">
                                </p>
                                <div style="display: flex; gap: 16px; font-size: 12px; color: #6c757d;">
                                    <span th:if="${blog.createdAt != null}">
                                        <span th:text="${#temporals.format(blog.createdAt, 'dd/MM/yyyy')}"></span>
                                    </span>
                                    <span th:if="${blog.viewCount != null}">
                                        <span th:text="${blog.viewCount}"></span> views
                                    </span>
                                    <span th:if="${blog.category != null}">
                                        <span th:text="${blog.category}"></span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${blogs == null or blogs.isEmpty()}" 
                             style="text-align: center; padding: 60px 20px; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                            <p style="font-size: 18px; color: #6c757d; margin: 0;">No blog posts found</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div th:if="${blogTotalPages != null and blogTotalPages > 1}" 
                         style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 30px;">
                        <a th:href="@{/admin(tab='blogs', status=${currentBlogStatus}, keyword=${blogKeyword}, blogPage=${blogCurrentPage - 1})}"
                           th:if="${blogCurrentPage > 0}"
                           style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; text-decoration: none; color: #007bff;">
                            ‚Üê Previous
                        </a>
                        <span th:each="i : ${#numbers.sequence(0, (blogTotalPages > 0 ? blogTotalPages - 1 : 0))}"
                              th:if="${i >= blogCurrentPage - 2 and i <= blogCurrentPage + 2}">
                            <a th:href="@{/admin(tab='blogs', status=${currentBlogStatus}, keyword=${blogKeyword}, blogPage=${i})}"
                               th:classappend="${i == blogCurrentPage} ? 'pagination-active'"
                               th:text="${i + 1}"
                               style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; text-decoration: none; color: #007bff; margin: 0 4px; display: inline-block;">
                            </a>
                        </span>
                        <a th:href="@{/admin(tab='blogs', status=${currentBlogStatus}, keyword=${blogKeyword}, blogPage=${blogCurrentPage + 1})}"
                           th:if="${blogCurrentPage < blogTotalPages - 1}"
                           style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; text-decoration: none; color: #007bff;">
                            Next ‚Üí
                        </a>
                    </div>
                </div>
            </div>

            <style>
                .blog-filter-active {
                    background: #007bff !important;
                    color: white !important;
                }
                .blog-filter-active span {
                    background: rgba(255,255,255,0.2) !important;
                    color: white !important;
                }
                .pagination-active {
                    background: #007bff !important;
                    color: white !important;
                    border-color: #007bff !important;
                }
                .badge.success { background: #28a745; color: white; }
                .badge.warning { background: #ffc107; color: #212529; }
                .badge.danger { background: #dc3545; color: white; }
                .badge.info { background: #17a2b8; color: white; }
                .badge.secondary { background: #6c757d; color: white; }
            </style>
        </section>
    </main>

    <!-- User Detail Modal -->
    <div id="userDetailModal" class="user-detail-modal">
        <div class="user-detail-content">
            <div class="user-detail-header">
                <h2>User Details</h2>
                <button class="close-btn" onclick="closeUserDetailModal()">
                    &times;
                </button>
            </div>
            <div class="user-detail-body">
                <div class="detail-row">
                    <div class="detail-label">ID:</div>
                    <div class="detail-value" id="detailId"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Full Name:</div>
                    <div class="detail-value" id="detailFullName"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Email:</div>
                    <div class="detail-value" id="detailEmail"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Phone:</div>
                    <div class="detail-value" id="detailPhone"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Address:</div>
                    <div class="detail-value" id="detailAddress"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Role:</div>
                    <div class="detail-value" id="detailRole"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value" id="detailActive"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Profile Completed:</div>
                    <div class="detail-value" id="detailProfileCompleted"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Login Method:</div>
                    <div class="detail-value" id="detailLoginMethod"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Created At:</div>
                    <div class="detail-value" id="detailCreatedAt"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit User -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <button class="close-modal" onclick="closeUserModal()">
                    &times;
                </button>
            </div>
            <form id="userForm" onsubmit="handleSaveUser(event)">
                <input type="hidden" id="userId" name="id" />

                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="fullName" name="fullName" required maxlength="255" class="form-control"
                        placeholder="e.g., John Doe" />
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" name="email" required maxlength="255" class="form-control"
                        placeholder="e.g., john@example.com" oninput="validateEmailRealtime()" />
                    <small id="emailError" style="font-size: 12px; display: none;"></small>
                </div>

                <div class="form-group" id="passwordGroup">
                    <label>Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="password" name="password" class="form-control"
                            placeholder="Enter your password" oninput="validatePasswordRealtime()" 
                            style="padding-right: 40px;" />
                        <span onclick="togglePasswordVisibility('password', 'togglePasswordIcon')" 
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px;">
                            <i id="togglePasswordIcon">üëÅÔ∏è</i>
                        </span>
                    </div>
                    <small id="passwordError" style="font-size: 12px; display: none;"></small>
                </div>

                <div class="form-group" id="confirmPasswordGroup">
                    <label>Confirm Password *</label>
                    <div style="position: relative;">
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control"
                            placeholder="Re-enter your password" oninput="validateConfirmPasswordRealtime()" 
                            style="padding-right: 40px;" />
                        <span onclick="togglePasswordVisibility('confirmPassword', 'toggleConfirmPasswordIcon')" 
                            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px;">
                            <i id="toggleConfirmPasswordIcon">üëÅÔ∏è</i>
                        </span>
                    </div>
                    <small id="confirmPasswordError" style="font-size: 12px; display: none;"></small>
                </div>

                <div class="form-group" id="resetPasswordGroup" style="display: none">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="resetPassword" id="resetPassword" style="width: auto; margin: 0;" />
                        <span>Reset Password</span>
                    </label>
                    <small style="margin-left: 28px;">Check to reset password to 12345678</small>
                </div>

                <div class="form-group">
                    <label>Role *</label>
                    <select id="roleCode" name="roleCode" required class="form-control">
                        <option th:each="role : ${roles}" th:value="${role.code}" th:text="${role.name}"></option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary " onclick="closeUserModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const contextPath = /*[[@{/}]]*/ "/";
        const csrfToken = document
            .querySelector("meta[name='_csrf']")
            ?.getAttribute("content");
        const csrfHeader = document
            .querySelector("meta[name='_csrf_header']")
            ?.getAttribute("content");
        /*]]>*/

        // --- 1. Helper: Fetch c√≥ b·∫£o m·∫≠t CSRF ---
        async function secureFetch(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (csrfToken && options.method && options.method !== "GET") {
                options.headers[csrfHeader] = csrfToken;
            }
            if (
                !options.headers["Content-Type"] &&
                !(options.body instanceof FormData)
            ) {
                options.headers["Content-Type"] = "application/json";
            }
            return fetch(url, options);
        }

        // --- 2. Notification (Th√¥ng b√°o ƒë·∫πp) ---
        function showNotification(message, type = "success") {
            const notif = document.createElement("div");
            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: ${type === "success" ? "#10B981" : "#EF4444"};
                color: white; padding: 12px 24px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999;
                display: flex; align-items: center; gap: 10px;
                animation: slideIn 0.3s ease; font-family: system-ui;
            `;
            notif.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.opacity = "0";
                notif.style.transition = "0.3s";
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        // Th√™m animation cho notification
        const style = document.createElement("style");
        style.innerHTML = `@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }`;
        document.head.appendChild(style);

        // --- 3. Handle Actions (AJAX) ---

        // TOGGLE STATUS
        async function toggleUserStatus(id, btn) {
            const originalText = btn.innerText;
            btn.innerText = "...";
            btn.disabled = true;

            try {
                const res = await secureFetch(
                    contextPath + `admin/users/${id}/toggle-active`,
                    { method: "POST" }
                );
                if (res.ok) {
                    showNotification("Status updated successfully", "success");

                    const tr = btn.closest("tr");
                    const isDeactivating = originalText.trim() === "Deactivate";
                    const span = btn.querySelector("span") || btn;
                    const actionBtnsContainer = btn.closest(".action-btns");

                    tr.setAttribute("data-active", isDeactivating ? "false" : "true");

                    const statusBadge = tr.querySelector("td:nth-last-child(2) .badge");
                    if (statusBadge) {
                        statusBadge.className = isDeactivating
                            ? "badge danger"
                            : "badge success";
                        statusBadge.innerText = isDeactivating ? "Inactive" : "Active";
                    }

                    if (isDeactivating) {
                        span.innerText = "Activate";
                        btn.className = "btn btn-sm btn-success";
                    } else {
                        span.innerText = "Deactivate";
                        btn.className = "btn btn-sm btn-danger";
                    }

                    const existingDeleteBtn =
                        actionBtnsContainer.querySelector(".btn-delete");
                    const userRole = tr.getAttribute("data-role");

                    if (isDeactivating && userRole !== "ROLE_ADMIN") {
                        if (!existingDeleteBtn) {
                            const deleteBtn = document.createElement("button");
                            deleteBtn.className = "btn btn-sm btn-danger btn-delete";
                            deleteBtn.innerHTML = "Delete";
                            deleteBtn.onclick = function () {
                                deleteUser(id, this);
                            };
                            actionBtnsContainer.appendChild(deleteBtn);
                        }
                    } else {
                        if (existingDeleteBtn) {
                            existingDeleteBtn.remove();
                        }
                    }

                    updateUserStats();
                } else {
                    showNotification(await res.text(), "error");
                    btn.innerText = originalText;
                }
            } catch (e) {
                showNotification("Error connecting to server", "error");
                btn.innerText = originalText;
            } finally {
                btn.disabled = false;
            }
        }

        // SAVE USER FUNCTION
        async function handleSaveUser(e) {
            e.preventDefault();

            if (!validateUserForm()) return;

            const form = document.getElementById("userForm");
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const isNew = !data.id;
            data.resetPassword = document.getElementById("resetPassword").checked;
            if (!data.id) data.id = null;

            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const res = await secureFetch(contextPath + "admin/users/save", {
                    method: "POST",
                    body: JSON.stringify(data),
                });

                if (res.ok) {
                    showNotification(
                        isNew ? "User created successfully" : "User updated successfully",
                        "success"
                    );
                    closeUserModal();

                    localStorage.setItem("adminActiveTab", "users");
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || "Error saving user", "error");
                }
            } catch (err) {
                console.error(err);
                showNotification("System error occurred", "error");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // UPDATE ROLE (AJAX)
        async function updateUserRole(userId, selectElement) {
            const newRoleCode = selectElement.value;
            const originalRole = selectElement.getAttribute("data-original-value");

            selectElement.disabled = true;

            try {
                const formData = new FormData();
                formData.append("roleCode", newRoleCode);

                const res = await secureFetch(
                    contextPath + `admin/users/${userId}/edit-role`,
                    {
                        method: "POST",
                        body: formData,
                    }
                );

                if (res.ok) {
                    const successMsg = await res.text();
                    showNotification(successMsg, "success");
                    selectElement.setAttribute("data-original-value", newRoleCode);

                    selectElement.closest("tr").setAttribute("data-role", newRoleCode);
                    updateUserStats();
                } else {
                    const errorMsg = await res.text();
                    showNotification(errorMsg, "error");
                    selectElement.value = originalRole;
                }
            } catch (error) {
                console.error(error);
                showNotification("Connection error", "error");
                selectElement.value = originalRole;
            } finally {
                selectElement.disabled = false;
            }
        }

        // DELETE USER
        async function deleteUser(id, btn) {
            if (!confirm('‚ö†Ô∏è Delete this user permanently? This action cannot be undone!')) return;

            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '...';

            try {
                const res = await secureFetch(contextPath + `admin/users/${id}/delete`, { method: 'POST' });
                if (res.ok) {
                    showNotification('User deleted successfully', 'success');

                    const tr = btn.closest('tr');
                    tr.style.transition = 'opacity 0.3s ease';
                    tr.style.opacity = '0';

                    setTimeout(() => {
                        tr.remove();
                        updateUserStats();
                    }, 300);

                } else {
                    showNotification(await res.text(), 'error');
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                showNotification('Error deleting user', 'error');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // USER SEARCH FUNCTION
        function filterUsers() {
            const searchInput = document.getElementById('userSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');

            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const email = row.cells[2].textContent.toLowerCase();
                
                if (name.includes(searchInput) || email.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // AUDIT LOG FILTER FUNCTION
        function filterAuditLog() {
            const actionFilter = document.getElementById('auditAction').value;
            const entityFilter = document.getElementById('auditEntity').value;
            const dateFilter = document.getElementById('auditDate').value;
            const rows = document.querySelectorAll('#auditLogTable tr');

            rows.forEach(row => {
                const action = row.getAttribute('data-action');
                const entity = row.getAttribute('data-entity');
                const date = row.getAttribute('data-date');

                let showRow = true;

                if (actionFilter !== 'all' && action !== actionFilter) {
                    showRow = false;
                }

                if (entityFilter !== 'all' && entity !== entityFilter) {
                    showRow = false;
                }

                if (dateFilter && date !== dateFilter) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            });
        }

        function clearAuditFilters() {
            document.getElementById('auditAction').value = 'all';
            document.getElementById('auditEntity').value = 'all';
            document.getElementById('auditDate').value = '';
            filterAuditLog();
        }

        // --- 4. Helpers & Init ---
        document.addEventListener("DOMContentLoaded", () => {
            const navItems = document.querySelectorAll(".nav-item");
            const sections = document.querySelectorAll(".content-section");
            const pageTitleEl = document.getElementById("pageTitle");

            function activateTab(sectionId, updateUrl = true) {
                navItems.forEach(n => n.classList.remove("active"));
                sections.forEach(s => s.classList.remove("active"));

                const activeNav = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
                if (activeNav) {
                    activeNav.classList.add("active");
                    if (pageTitleEl) {
                        pageTitleEl.textContent = activeNav.textContent.trim();
                    }
                }

                const activeSection = document.getElementById(sectionId);
                if (activeSection) {
                    activeSection.classList.add("active");
                }

                // C·∫≠p nh·∫≠t URL v·ªõi ?tab= ƒë·ªÉ gi·ªØ tab khi reload
                if (updateUrl) {
                    const url = new URL(window.location);
                    url.searchParams.set('tab', sectionId);
                    window.history.pushState({ tab: sectionId }, '', url);
                }

                // Khi chuy·ªÉn sang tab Analytics th√¨ load d·ªØ li·ªáu
                if (sectionId === "analytics") {
                    loadAnalyticsOverview();
                }
            }

            // L·∫•y tab t·ª´ URL parameter - ∆ØU TI√äN DUY NH·∫§T
            const urlParams = new URLSearchParams(window.location.search);
            const tabFromUrl = urlParams.get('tab');
            
            // CH·ªà l·∫•y t·ª´ URL parameter, n·∫øu kh√¥ng c√≥ th√¨ m·∫∑c ƒë·ªãnh dashboard
            // KH√îNG s·ª≠ d·ª•ng localStorage khi reload ƒë·ªÉ tr√°nh nh·∫£y v√†o tab sai
            let savedTab = tabFromUrl || "dashboard";
            activateTab(savedTab, false); // Kh√¥ng c·∫≠p nh·∫≠t URL khi load l·∫ßn ƒë·∫ßu (URL ƒë√£ c√≥ s·∫µn)

            navItems.forEach((item) => {
                item.addEventListener("click", function (e) {
                    e.preventDefault();
                    const sectionId = this.dataset.section;
                    if (sectionId) {
                        activateTab(sectionId, true); // C·∫≠p nh·∫≠t URL khi click
                    }
                });
            });
            
            // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng d√πng browser back/forward
            window.addEventListener('popstate', function(e) {
                const urlParams = new URLSearchParams(window.location.search);
                const tabFromUrl = urlParams.get('tab') || 'dashboard';
                activateTab(tabFromUrl, false);
            });

            updateUserStats();

            // User search event listener
            const userSearchInput = document.getElementById('userSearchInput');
            if (userSearchInput) {
                userSearchInput.addEventListener('input', filterUsers);
            }

            // Audit log filter event listeners
            document.getElementById('auditAction')?.addEventListener('change', filterAuditLog);
            document.getElementById('auditEntity')?.addEventListener('change', filterAuditLog);
            document.getElementById('auditDate')?.addEventListener('change', filterAuditLog);

            const emailInput = document.getElementById("email");
            if (emailInput) {
                emailInput.addEventListener("blur", function () {
                    const email = this.value;
                    const id = document.getElementById("userId").value;
                    if (!email) return;
                    fetch(
                        `${contextPath}admin/check-email?email=${encodeURIComponent(
                            email
                        )}${id ? "&id=" + id : ""}`
                    )
                        .then((r) => r.json())
                        .then((d) => {
                            const err = document.getElementById("emailError");
                            const btn = document.querySelector(
                                '#userModal button[type="submit"]'
                            );
                            if (d.exists) {
                                err.textContent = "Email exists";
                                btn.disabled = true;
                            } else {
                                err.textContent = "";
                                btn.disabled = false;
                            }
                        });
                });
            }

            const dropdownToggle = document.querySelector(".dropdown-toggle");
            const dropdownMenu = document.querySelector(".dropdown-menu");

            if (dropdownToggle && dropdownMenu) {
                dropdownToggle.addEventListener("click", (e) => {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle("show");
                });

                document.addEventListener("click", (e) => {
                    if (!e.target.closest(".profile-dropdown")) {
                        dropdownMenu.classList.remove("show");
                    }
                });
            }
            // T·ª± load analytics n·∫øu tab ƒëang active
            if (savedTab === "analytics") {
                loadAnalyticsOverview();
            }

            const analyticsDaysSelect = document.getElementById("analyticsDays");
            if (analyticsDaysSelect) {
                analyticsDaysSelect.addEventListener("change", () => {
                    loadAnalyticsOverview();
                });
            }
        });

        async function loadAnalyticsOverview() {
            const daysSelect = document.getElementById("analyticsDays");
            const days = daysSelect ? daysSelect.value : 30;
            const noteEl = document.getElementById("salesChartNote");
            const lineContainer = document.getElementById("salesChartLine");
            const categoryContainer = document.getElementById("categoryStats");

            if (noteEl) {
                noteEl.textContent = "Loading analytics data...";
            }
            if (lineContainer) {
                lineContainer.innerHTML = "";
            }
            if (categoryContainer) {
                categoryContainer.innerHTML = "";
            }

            try {
                const res = await fetch(`${contextPath}admin/analytics/overview?days=${encodeURIComponent(days)}`);
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const data = await res.json();

                updateAnalyticsSummary(data);
                renderSalesChart(data);
                renderCategoryDistribution(data);

                if (noteEl) {
                    noteEl.textContent = `Showing last ${days} days of revenue (PAID / CONFIRMED / DELIVERED orders)`;
                }
            } catch (e) {
                console.error(e);
                if (noteEl) {
                    noteEl.textContent = "Failed to load analytics data";
                }
            }
        }

        function formatCurrency(amount) {
            if (amount == null) return "0";
            try {
                const num = typeof amount === "number" ? amount : Number(amount);
                if (Number.isNaN(num)) return "0";
                return num.toLocaleString("en-US", { style: "currency", currency: "USD" });
            } catch {
                return amount;
            }
        }

        function updateAnalyticsSummary(data) {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            const totalRevenue = data.totalRevenue || 0;
            setText("analyticsTotalRevenue", formatCurrency(totalRevenue));
            setText("analyticsTotalOrders", data.totalOrders ?? 0);
            setText("analyticsCompletedOrders", data.completedOrders ?? 0);
            setText("analyticsPendingCancelled", `${data.pendingOrders ?? 0} / ${data.cancelledOrders ?? 0}`);
        }

        function renderSalesChart(data) {
            const container = document.getElementById("salesChartLine");
            if (!container || !data || !Array.isArray(data.salesByDate)) return;

            const points = data.salesByDate;
            const maxRevenue = points.reduce((max, p) => {
                const v = typeof p.revenue === "number" ? p.revenue : Number(p.revenue || 0);
                return v > max ? v : max;
            }, 0);

            if (maxRevenue <= 0) {
                container.innerHTML = "<p style='font-size: 13px; color: #6b7280;'>No completed orders in selected range.</p>";
                return;
            }

            const svgNS = "http://www.w3.org/2000/svg";
            const width = Math.max(points.length * 40, container.clientWidth || 680);
            const height = 190;
            const padding = { top: 10, right: 30, bottom: 30, left: 30 };

            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.setAttribute("preserveAspectRatio", "none");

            // Grid lines
            const grid = document.createElementNS(svgNS, "g");
            grid.setAttribute("class", "sales-line-grid");
            const gridCount = 4;
            for (let i = 0; i <= gridCount; i++) {
                const y = padding.top + ((height - padding.top - padding.bottom) / gridCount) * i;
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", padding.left);
                line.setAttribute("x2", width - padding.right);
                line.setAttribute("y1", y);
                line.setAttribute("y2", y);
                grid.appendChild(line);
            }
            svg.appendChild(grid);

            const scaleX = (index) => padding.left + ((width - padding.left - padding.right) / Math.max(points.length - 1, 1)) * index;
            const scaleY = (value) => {
                const plotHeight = height - padding.top - padding.bottom;
                const ratio = value / maxRevenue;
                return padding.top + plotHeight - plotHeight * ratio;
            };

            const linePoints = points.map((p, idx) => {
                const val = typeof p.revenue === "number" ? p.revenue : Number(p.revenue || 0);
                return `${scaleX(idx)},${scaleY(val)}`;
            }).join(" ");

            // Area fill
            const areaPath = document.createElementNS(svgNS, "path");
            const firstX = scaleX(0);
            const lastX = scaleX(points.length - 1);
            const baseY = height - padding.bottom;
            const areaD = `M ${firstX},${baseY} L ${linePoints.replace(/ /g, " L ")} L ${lastX},${baseY} Z`;
            areaPath.setAttribute("d", areaD);
            areaPath.setAttribute("class", "sales-line-area");
            svg.appendChild(areaPath);

            const linePath = document.createElementNS(svgNS, "polyline");
            linePath.setAttribute("points", linePoints);
            linePath.setAttribute("class", "sales-line-path");
            svg.appendChild(linePath);

            // Dots + labels
            points.forEach((p, idx) => {
                const value = typeof p.revenue === "number" ? p.revenue : Number(p.revenue || 0);
                const cx = scaleX(idx);
                const cy = scaleY(value);

                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", cx);
                circle.setAttribute("cy", cy);
                circle.setAttribute("r", 4);
                circle.setAttribute("class", "sales-line-dot");
                circle.setAttribute("title", `${p.date}: ${formatCurrency(value)} (${p.orders} orders)`);
                svg.appendChild(circle);

                if (points.length <= 15 || idx % 2 === 0) {
                    const label = document.createElementNS(svgNS, "text");
                    label.setAttribute("x", cx);
                    label.setAttribute("y", height - 6);
                    label.setAttribute("text-anchor", "middle");
                    label.setAttribute("class", "sales-line-label");
                    label.textContent = p.date?.substring(5);
                    svg.appendChild(label);
                }
            });

            container.innerHTML = "";
            container.appendChild(svg);
        }

        function renderCategoryDistribution(data) {
            const container = document.getElementById("categoryStats");
            if (!container) return;

            const items = data && Array.isArray(data.categoryDistribution)
                ? data.categoryDistribution
                : [];

            if (items.length === 0) {
                container.innerHTML = "<p style='font-size: 13px; color: #6b7280;'>No category data available yet.</p>";
                return;
            }

            container.innerHTML = "";
            items.forEach(item => {
                const percent = item.percent != null ? item.percent : 0;

                const wrapper = document.createElement("div");
                wrapper.className = "category-item";

                const nameEl = document.createElement("span");
                nameEl.className = "category-name";
                nameEl.textContent = item.categoryName || "Other";

                const progressBar = document.createElement("div");
                progressBar.className = "progress-bar";

                const fill = document.createElement("div");
                fill.className = "progress-fill";
                fill.style.width = `${Math.min(100, Math.max(0, percent))}%`;
                progressBar.appendChild(fill);

                const rightInfo = document.createElement("span");
                rightInfo.className = "category-percent";
                rightInfo.textContent = `${percent.toFixed(1)}% ‚Ä¢ ${item.quantity} items`;
                rightInfo.title = `Revenue: ${formatCurrency(item.revenue)}`;

                wrapper.appendChild(nameEl);
                wrapper.appendChild(progressBar);
                wrapper.appendChild(rightInfo);

                container.appendChild(wrapper);
            });
        }

        function updateUserStats() {
            const rows = document.querySelectorAll("#userTableBody tr");
            let active = 0,
                inactive = 0,
                admins = 0,
                staff = 0;

            rows.forEach((r) => {
                if (r.style.display === 'none') return; // Skip hidden rows
                
                const isActive = r.getAttribute("data-active") === "true";
                const roleCode = r.getAttribute("data-role");

                if (isActive) active++;
                else inactive++;
                if (roleCode === "ROLE_ADMIN") admins++;
                if (roleCode === "ROLE_STAFF") staff++;
            });

            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = val;
            };
            set("totalUsersStat", rows.length);
            set("activeUsersStat", active);
            set("inactiveUsersStat", inactive);
            set("adminStaffStat", `${admins} admin / ${staff} staff`);
            set("headerActiveUsers", active);
            set("headerTotalUsers", rows.length);
        }

        document.getElementById("addUserBtn")?.addEventListener("click", () => {
            document.getElementById("userModalTitle").textContent = "Add User";
            document.getElementById("userForm").reset();
            document.getElementById("userId").value = "";
            document.getElementById("passwordGroup").style.display = "block";
            document.getElementById("confirmPasswordGroup").style.display = "block";
            document.getElementById("resetPasswordGroup").style.display = "none";
            document.getElementById("password").required = true;
            document.getElementById("confirmPassword").required = true;
            document.getElementById("email").required = true;
            document.getElementById("email").readOnly = false;
            document.getElementById("email").style.backgroundColor = "#ffffff";
            document.getElementById("emailError").textContent = "";
            document.getElementById("confirmPasswordError").textContent = "";
            document.getElementById("userModal").style.display = "flex";
        });

        function editUser(id) {
            fetch(contextPath + "admin/users/" + id)
                .then((r) => r.json())
                .then((u) => {
                    document.getElementById("userModalTitle").textContent = "Edit User";
                    document.getElementById("userId").value = u.id;
                    document.getElementById("fullName").value = u.fullName;
                    document.getElementById("email").value = u.email;
                    document.getElementById("email").readOnly = true;
                    document.getElementById("email").style.backgroundColor = "#f3f4f6";
                    document.getElementById("email").required = true;
                    document.getElementById("roleCode").value = u.role.code;
                    document.getElementById("password").value = "";
                    document.getElementById("password").required = false;
                    document.getElementById("confirmPassword").value = "";
                    document.getElementById("confirmPassword").required = false;
                    document.getElementById("passwordGroup").style.display = "none";
                    document.getElementById("confirmPasswordGroup").style.display = "none";
                    document.getElementById("resetPasswordGroup").style.display = "block";
                    document.getElementById("resetPassword").checked = false;
                    document.getElementById("emailError").textContent = "";
                    document.getElementById("confirmPasswordError").textContent = "";
                    document.getElementById("userModal").style.display = "flex";
                })
                .catch(() => showNotification("Error loading user", "error"));
        }

        function viewUser(id) {
            fetch(contextPath + "admin/users/" + id)
                .then((r) => r.json())
                .then((u) => {
                    document.getElementById("detailId").textContent = u.id;
                    document.getElementById("detailFullName").textContent = u.fullName;
                    document.getElementById("detailEmail").textContent = u.email;
                    document.getElementById("detailRole").textContent = u.role.name;
                    document.getElementById(
                        "detailActive"
                    ).innerHTML = `<span class="badge ${u.active ? "success" : "danger"
                        }">${u.active ? "Active" : "Inactive"}</span>`;
                    document.getElementById("userDetailModal").style.display = "flex";
                });
        }

        function closeUserModal() {
            document.getElementById("userModal").style.display = "none";
        }
        function closeUserDetailModal() {
            document.getElementById("userDetailModal").style.display = "none";
        }

        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);

            if (input.type === "password") {
                input.type = "text";
                icon.textContent = "üôà";
            } else {
                input.type = "password";
                icon.textContent = "üëÅÔ∏è";
            }
        }

        function validateEmailRealtime() {
            const email = document.getElementById("email").value;
            const emailError = document.getElementById("emailError");
            const userId = document.getElementById("userId").value;

            if (email.length > 0) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) {
                    emailError.textContent = "Invalid email format";
                    emailError.style.color = "#dc2626";
                    emailError.style.display = "block";
                    return;
                }

                fetch(`${contextPath}admin/check-email?email=${encodeURIComponent(email)}${userId ? "&id=" + userId : ""}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.exists) {
                            emailError.textContent = "Email already exists";
                            emailError.style.color = "#dc2626";
                            emailError.style.display = "block";
                        } else {
                            emailError.textContent = "Email available";
                            emailError.style.color = "#10B981";
                            emailError.style.display = "block";
                        }
                    })
                    .catch(() => {
                        emailError.style.display = "none";
                    });
            } else {
                emailError.style.display = "none";
            }
        }

        function validatePasswordRealtime() {
            const pwd = document.getElementById("password").value;
            const passwordError = document.getElementById("passwordError");
            const pattern = /^(?=.*[A-Z])(?=.*\d)(?=.*[@#$%^&+=!])(?=\S+$).{8,}$/;

            if (pwd.length > 0) {
                if (!pattern.test(pwd)) {
                    passwordError.textContent = "Must be 8+ chars: 1 uppercase, 1 digit, 1 special (!@#$%^&*)";
                    passwordError.style.color = "#dc2626";
                    passwordError.style.display = "block";
                } else {
                    passwordError.textContent = "Strong password";
                    passwordError.style.color = "#10B981";
                    passwordError.style.display = "block";
                }
            } else {
                passwordError.style.display = "none";
            }

            validateConfirmPasswordRealtime();
        }

        function validateConfirmPasswordRealtime() {
            const pwd = document.getElementById("password").value;
            const confirmPwd = document.getElementById("confirmPassword").value;
            const confirmPasswordError = document.getElementById("confirmPasswordError");

            if (confirmPwd.length > 0) {
                if (pwd === confirmPwd) {
                    confirmPasswordError.textContent = "Passwords match";
                    confirmPasswordError.style.color = "#10B981";
                    confirmPasswordError.style.display = "block";
                } else {
                    confirmPasswordError.textContent = "Passwords must match";
                    confirmPasswordError.style.color = "#dc2626";
                    confirmPasswordError.style.display = "block";
                }
            } else {
                confirmPasswordError.style.display = "none";
            }
        }

        function validateUserForm() {
            const isNew = !document.getElementById("userId").value;
            const pwd = document.getElementById("password").value;
            const confirmPwd = document.getElementById("confirmPassword").value;
            const pattern = /^(?=.*[A-Z])(?=.*\d)(?=.*[@#$%^&+=!])(?=\S+$).{8,}$/;

            const confirmPasswordError = document.getElementById("confirmPasswordError");

            if (confirmPasswordError) {
                confirmPasswordError.textContent = "";
            }

            if (isNew) {
                if (!pwd || pwd.trim() === "") {
                    showNotification("Password is required!", "error");
                    return false;
                }

                if (!pattern.test(pwd)) {
                    showNotification("Password must be 8+ chars: 1 uppercase, 1 digit, 1 special (!@#$%^&*)", "error");
                    return false;
                }

                if (pwd !== confirmPwd) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = "Passwords must match";
                    }
                    showNotification("Passwords must match!", "error");
                    return false;
                }
            }

            return true;
        }

        // ===== BLOG MANAGEMENT (AJAX) =====

        // Approve Blog (PENDING_REVIEW -> PUBLISHED)
        async function approveBlog(id, btn) {
            if (!confirm('Approve and publish this blog?')) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Approving...';

            try {
                const res = await secureFetch(contextPath + `admin/blog/approve/${id}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message || 'Blog approved and published successfully!', 'success');
                    
                    // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë∆∞·ª£c refresh
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || 'Failed to approve blog', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                showNotification('System error occurred', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Reject Blog (PENDING_REVIEW -> DRAFT)
        async function rejectBlog(id, btn) {
            if (!confirm('Reject this blog? It will return to DRAFT status.')) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Rejecting...';

            try {
                const res = await secureFetch(contextPath + `admin/blog/reject/${id}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message || 'Blog rejected and returned to DRAFT status', 'success');
                    
                    // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë∆∞·ª£c refresh
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || 'Failed to reject blog', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                showNotification('System error occurred', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Archive Blog (PUBLISHED -> ARCHIVED)
        async function archiveBlog(id, btn) {
            if (!confirm('Archive this blog?')) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Archiving...';

            try {
                const res = await secureFetch(contextPath + `admin/blog/archive/${id}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message || 'Blog archived successfully!', 'success');
                    
                    // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë∆∞·ª£c refresh
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || 'Failed to archive blog', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                showNotification('System error occurred', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Unarchive Blog (ARCHIVED -> PUBLISHED)
        async function unarchiveBlog(id, btn) {
            if (!confirm('Unarchive this blog?')) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Unarchiving...';

            try {
                const res = await secureFetch(contextPath + `admin/blog/unarchive/${id}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message || 'Blog unarchived successfully!', 'success');
                    
                    // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë∆∞·ª£c refresh
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || 'Failed to unarchive blog', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                showNotification('System error occurred', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Approve Delete Request (PENDING_DELETE -> deleted)
        async function approveDelete(id, btn) {
            if (!confirm('‚ö†Ô∏è X√°c nh·∫≠n x√≥a blog n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const res = await secureFetch(contextPath + `admin/blog/approve-delete/${id}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message || 'Blog ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!', 'success');
                    
                    // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë∆∞·ª£c refresh
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || 'Failed to approve delete', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                showNotification('System error occurred', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Reject Delete Request (PENDING_DELETE -> PUBLISHED)
        async function rejectDelete(id, btn) {
            if (!confirm('T·ª´ ch·ªëi y√™u c·∫ßu x√≥a blog n√†y? Blog s·∫Ω ƒë∆∞·ª£c tr·∫£ v·ªÅ tr·∫°ng th√°i PUBLISHED.')) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Rejecting...';

            try {
                const res = await secureFetch(contextPath + `admin/blog/reject-delete/${id}`, {
                    method: 'POST'
                });

                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message || 'Y√™u c·∫ßu x√≥a ƒë√£ b·ªã t·ª´ ch·ªëi. Blog ƒë√£ ƒë∆∞·ª£c tr·∫£ v·ªÅ PUBLISHED!', 'success');
                    
                    // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë∆∞·ª£c refresh
                    setTimeout(() => location.reload(), 800);
                } else {
                    const text = await res.text();
                    showNotification(text || 'Failed to reject delete', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                showNotification('System error occurred', 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Check for login success on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('loginSuccess') === 'true') {
                setTimeout(() => {
                    showNotification('Welcome Back, Admin! üéâ You have successfully logged in.', 'success');
                }, 300);
                
                // Remove param from URL after showing notification
                setTimeout(() => {
                    const url = new URL(window.location);
                    url.searchParams.delete('loginSuccess');
                    window.history.replaceState({}, '', url);
                }, 4500);
            }
        });
    </script>
</body>

</html>