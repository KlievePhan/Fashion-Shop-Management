<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fashion Shop Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/admin.css}" />
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo">
            <h2>Fashion Shop</h2>
        </div>
        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-section="dashboard">
                <span class="icon">üìä</span> Dashboard
            </a>
            <a href="#" class="nav-item" data-section="users">
                <span class="icon">üë•</span> Users
            </a>
            <a href="#" class="nav-item" data-section="analytics">
                <span class="icon">üìà</span> Analytics
            </a>
            <a href="#" class="nav-item" data-section="auditlog">
                <span class="icon">üìã</span> Audit Log
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                <div class="header-title-section">
                    <h1 id="pageTitle">Dashboard</h1>
                    <p class="header-subtitle" id="headerSubtitle">
                        Welcome back, Admin
                    </p>
                </div>
            </div>
            <div class="header-right">
                <div class="status-info">
                    <div class="status-item">
                        <span class="status-label">Active Users</span>
                        <span class="status-value" id="headerActiveUsers">0</span>
                    </div>
                    <div class="status-divider"></div>
                    <div class="status-item">
                        <span class="status-label">Total Users</span>
                        <span class="status-value" id="headerTotalUsers">0</span>
                    </div>
                </div>
                <div class="search-bar">
                    <input type="text" placeholder="Search users, logs..." id="searchInput" />
                    <i class="search-icon">üîç</i>
                </div>
                <div class="notifications">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="bell-icon">üîî</i>
                        <span class="notification-badge">3</span>
                    </button>
                </div>
                <div class="user-profile">
                    <div class="avatar">A</div>
                    <div class="user-info">
                        <span class="user-name">Admin</span>
                        <span class="user-role">Administrator</span>
                    </div>
                    <div class="profile-dropdown">
                        <button class="dropdown-toggle">‚ãÆ</button>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item"> <i>üë§</i> Profile </a>
                            <a href="#" class="dropdown-item"> <i>‚öôÔ∏è</i> Settings </a>
                            <div class="dropdown-divider"></div>
                            <form th:action="@{/logout}" method="post" style="margin: 0">
                                <button type="submit" class="dropdown-item logout-item">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon red">üë•</div>
                    <div class="stat-info">
                        <h3>Total Users</h3>
                        <p class="stat-value" id="totalUsersStat">0</p>
                        <span class="stat-change">All registered accounts</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <h3>Active Users</h3>
                        <p class="stat-value" id="activeUsersStat">0</p>
                        <span class="stat-change positive">Can log in & use system</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚õî</div>
                    <div class="stat-info">
                        <h3>Inactive Users</h3>
                        <p class="stat-value" id="inactiveUsersStat">0</p>
                        <span class="stat-change warning">Locked / deactivated</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üëë</div>
                    <div class="stat-info">
                        <h3>Admin & Staff</h3>
                        <p class="stat-value" id="adminStaffStat">0 admin / 0 staff</p>
                        <span class="stat-change info">Privileged accounts</span>
                    </div>
                </div>
            </div>
            <!-- gi·ªØ l·∫°i 2 card demo c≈© n·∫øu mu·ªën -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Recent Orders</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable">
                                <tr>
                                    <td>#ORD-001</td>
                                    <td>John Doe</td>
                                    <td>$125.00</td>
                                    <td><span class="badge success">Purchased</span></td>
                                </tr>
                                <tr>
                                    <td>#ORD-002</td>
                                    <td>Jane Smith</td>
                                    <td>$89.50</td>
                                    <td><span class="badge warning">Pending</span></td>
                                </tr>
                                <tr>
                                    <td>#ORD-003</td>
                                    <td>Mike Johnson</td>
                                    <td>$245.00</td>
                                    <td><span class="badge warning">Pending</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3>Top Products</h3>
                    <div class="product-list">
                        <div class="product-item">
                            <span class="product-name">Classic T-Shirt</span>
                            <span class="product-sales">245 sales</span>
                        </div>
                        <div class="product-item">
                            <span class="product-name">Denim Jeans</span>
                            <span class="product-sales">198 sales</span>
                        </div>
                        <div class="product-item">
                            <span class="product-name">Leather Jacket</span>
                            <span class="product-sales">156 sales</span>
                        </div>
                        <div class="product-item">
                            <span class="product-name">Summer Dress</span>
                            <span class="product-sales">143 sales</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="users" class="content-section">
            <div class="section-header">
                <h2>Users Management</h2>
                <button class="btn btn-primary" id="addUserBtn">+ Add User</button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}" th:data-role="${user.role.code}"
                                th:data-active="${user.active}">
                                <td th:text="${user.id}"></td>
                                <td th:text="${user.fullName}"></td>
                                <td th:text="${user.email}"></td>
                                <td>
                                    <div th:if="${user.role.code != 'ROLE_ADMIN'}">
                                        <select class="role-select form-control input-sm"
                                            th:disabled="${user.id == currentUserId}"
                                            th:data-original-value="${user.role.code}"
                                            onfocus="this.setAttribute('data-original-value', this.value)"
                                            th:onchange="'updateUserRole(' + ${user.id} + ', this)'">
                                            <option th:each="role : ${roles}" th:value="${role.code}"
                                                th:text="${role.name}" th:selected="${user.role.code == role.code}">
                                            </option>
                                        </select>
                                    </div>

                                    <span th:if="${user.role.code == 'ROLE_ADMIN'}" class="badge admin"
                                        th:text="${user.role.name}"></span>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="${user.active ? 'success' : 'danger'}"
                                        th:text="${user.active ? 'Active' : 'Inactive'}"></span>
                                </td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn btn-sm btn-secondary"
                                            th:onclick="'viewUser(' + ${user.id} + ')'">
                                            View
                                        </button>

                                        <button class="btn btn-sm btn-secondary"
                                            th:onclick="'editUser(' + ${user.id} + ')'"
                                            th:if="${user.id != currentUserId and user.role.code != 'ROLE_ADMIN'}">
                                            Edit
                                        </button>

                                        <button th:if="${user.role.code != 'ROLE_ADMIN'}" class="btn btn-sm"
                                            th:classappend="${user.active ? 'btn-danger' : 'btn-success'}"
                                            th:onclick="'toggleUserStatus(' + ${user.id} + ', this)'"
                                            th:disabled="${user.id == currentUserId}">
                                            <span th:text="${user.active ? 'Deactivate' : 'Activate'}"></span>
                                        </button>

                                        <button th:if="${!user.active and user.role.code != 'ROLE_ADMIN'}"
                                            class="btn btn-sm btn-danger btn-delete"
                                            th:onclick="'deleteUser(' + ${user.id} + ', this)'">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="content-section">
            <div class="section-header">
                <h2>Analytics</h2>
            </div>
            <div class="analytics-grid">
                <div class="card">
                    <h3>Sales Overview</h3>
                    <div class="chart-placeholder">
                        <p>üìà Sales chart visualization</p>
                        <p class="chart-note">
                            Connect to your Spring Boot backend to display real-time data
                        </p>
                    </div>
                </div>
                <div class="card">
                    <h3>Category Distribution</h3>
                    <div class="category-stats">
                        <div class="category-item">
                            <span class="category-name">T-Shirts</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 45%"></div>
                            </div>
                            <span class="category-percent">45%</span>
                        </div>
                        <div class="category-item">
                            <span class="category-name">Jeans</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 30%"></div>
                            </div>
                            <span class="category-percent">30%</span>
                        </div>
                        <div class="category-item">
                            <span class="category-name">Jackets</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 15%"></div>
                            </div>
                            <span class="category-percent">15%</span>
                        </div>
                        <div class="category-item">
                            <span class="category-name">Accessories</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 10%"></div>
                            </div>
                            <span class="category-percent">10%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Audit Log Section -->
        <section id="auditlog" class="content-section">
            <div class="section-header">
                <h2>Audit Log</h2>
                <div class="filter-group">
                    <select class="filter-select" id="auditAction">
                        <option value="all">All Actions</option>
                        <option value="CREATE">Create</option>
                        <option value="UPDATE">Update</option>
                        <option value="DELETE">Delete</option>
                        <option value="VIEW">View</option>
                    </select>
                    <select class="filter-select" id="auditEntity">
                        <option value="all">All Entities</option>
                        <option value="Product">Product</option>
                        <option value="Brand">Brand</option>
                        <option value="Order">Order</option>
                        <option value="User">User</option>
                    </select>
                    <input type="date" class="filter-select" id="auditDate" />
                </div>
            </div>
            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Actor</th>
                                <th>Role</th>
                                <th>Action</th>
                                <th>Entity</th>
                                <th>Changes</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <tr th:each="log : ${auditLogs}">
                                <td th:text="${log.id}"></td>
                                <td th:text="${log.actor != null ? log.actor.fullName : 'System'}"></td>
                                <td th:text="${log.actorRole}"></td>
                                <td>
                                    <span class="badge"
                                        th:classappend="${log.action == 'CREATE' ? 'success' : (log.action == 'DELETE' ? 'danger' : (log.action == 'UPDATE' ? 'warning' : 'info'))}"
                                        th:text="${log.action}"></span>
                                </td>
                                <td th:text="${log.entity}"></td>
                                <td>
                                    <span class="changes-preview" th:title="${log.changes}"
                                        th:text="${#strings.abbreviate(log.changes, 50)}"></span>
                                </td>
                                <td th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- User Detail Modal -->
    <div id="userDetailModal" class="user-detail-modal">
        <div class="user-detail-content">
            <div class="user-detail-header">
                <h2>User Details</h2>
                <button class="close-btn" onclick="closeUserDetailModal()">
                    &times;
                </button>
            </div>
            <div class="user-detail-body">
                <div class="detail-row">
                    <div class="detail-label">ID:</div>
                    <div class="detail-value" id="detailId"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Full Name:</div>
                    <div class="detail-value" id="detailFullName"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Email:</div>
                    <div class="detail-value" id="detailEmail"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Phone:</div>
                    <div class="detail-value" id="detailPhone"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Address:</div>
                    <div class="detail-value" id="detailAddress"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Role:</div>
                    <div class="detail-value" id="detailRole"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status:</div>
                    <div class="detail-value" id="detailActive"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Profile Completed:</div>
                    <div class="detail-value" id="detailProfileCompleted"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Login Method:</div>
                    <div class="detail-value" id="detailLoginMethod"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Created At:</div>
                    <div class="detail-value" id="detailCreatedAt"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit User -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <button class="close-modal" onclick="closeUserModal()">
                    &times;
                </button>
            </div>
            <form id="userForm" onsubmit="handleSaveUser(event)">
                <input type="hidden" id="userId" name="id" />

                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="fullName" name="fullName" required maxlength="255" class="form-control"
                        placeholder="e.g., John Doe" />
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" name="email" required maxlength="255" class="form-control"
                        placeholder="e.g., john@example.com" />
                    <small id="emailError" style="color: #dc2626; font-size: 12px"></small>
                </div>

                <div class="form-group" id="passwordGroup">
                    <label>Password
                        <span id="passwordHint" style="color: #6b7280; font-size: 12px">
                            (required for new users)
                        </span>
                    </label>
                    <input type="password" id="password" name="password" class="form-control"
                        placeholder="Leave blank to keep current" />
                    <div class="password-hint">
                        <strong>Password requirements:</strong>
                        <ul>
                            <li>At least 8 characters</li>
                            <li>At least 1 uppercase letter, 1 number, 1 special char</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group" id="resetPasswordGroup" style="display: none">
                    <label>Reset Password</label>
                    <input type="checkbox" name="resetPassword" id="resetPassword" />
                    <small>Check to reset password to 12345678</small>
                </div>

                <div class="form-group">
                    <label>Role</label>
                    <select id="roleCode" name="roleCode" required class="form-control">
                        <option th:each="role : ${roles}" th:value="${role.code}" th:text="${role.name}"></option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal" onclick="closeUserModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const contextPath = /*[[@{/}]]*/ "/";
        const csrfToken = document
            .querySelector("meta[name='_csrf']")
            ?.getAttribute("content");
        const csrfHeader = document
            .querySelector("meta[name='_csrf_header']")
            ?.getAttribute("content");
        /*]]>*/

        // --- 1. Helper: Fetch c√≥ b·∫£o m·∫≠t CSRF ---
        async function secureFetch(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (csrfToken && options.method && options.method !== "GET") {
                options.headers[csrfHeader] = csrfToken;
            }
            if (
                !options.headers["Content-Type"] &&
                !(options.body instanceof FormData)
            ) {
                options.headers["Content-Type"] = "application/json";
            }
            return fetch(url, options);
        }

        // --- 2. Notification (Th√¥ng b√°o ƒë·∫πp) ---
        function showNotification(message, type = "success") {
            const notif = document.createElement("div");
            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: ${type === "success" ? "#10B981" : "#EF4444"};
                color: white; padding: 12px 24px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999;
                display: flex; align-items: center; gap: 10px;
                animation: slideIn 0.3s ease; font-family: system-ui;
            `;
            notif.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.opacity = "0";
                notif.style.transition = "0.3s";
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        // Th√™m animation cho notification
        const style = document.createElement("style");
        style.innerHTML = `@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }`;
        document.head.appendChild(style);

        // --- 3. Handle Actions (AJAX) ---

        // TOGGLE STATUS
        async function toggleUserStatus(id, btn) {
            const originalText = btn.innerText;
            btn.innerText = "...";
            btn.disabled = true;

            try {
                const res = await secureFetch(
                    contextPath + `admin/users/${id}/toggle-active`,
                    { method: "POST" }
                );
                if (res.ok) {
                    showNotification("Status updated successfully", "success");

                    const tr = btn.closest("tr");
                    const isDeactivating = originalText.trim() === "Deactivate";
                    const span = btn.querySelector("span") || btn;
                    const actionBtnsContainer = btn.closest(".action-btns");

                    // 1. C·∫≠p nh·∫≠t data-active attribute
                    tr.setAttribute("data-active", isDeactivating ? "false" : "true");

                    // 2. C·∫≠p nh·∫≠t badge status
                    const statusBadge = tr.querySelector("td:nth-last-child(2) .badge");
                    if (statusBadge) {
                        statusBadge.className = isDeactivating
                            ? "badge danger"
                            : "badge success";
                        statusBadge.innerText = isDeactivating ? "Inactive" : "Active";
                    }

                    // 3. C·∫≠p nh·∫≠t n√∫t Activate/Deactivate
                    if (isDeactivating) {
                        span.innerText = "Activate";
                        btn.className = "btn btn-sm btn-success";
                    } else {
                        span.innerText = "Deactivate";
                        btn.className = "btn btn-sm btn-danger";
                    }

                    // 4. X·ª≠ l√Ω n√∫t Delete (‚òÖ PH·∫¶N QUAN TR·ªåNG ‚òÖ)
                    const existingDeleteBtn =
                        actionBtnsContainer.querySelector(".btn-delete");
                    const userRole = tr.getAttribute("data-role");

                    if (isDeactivating && userRole !== "ROLE_ADMIN") {
                        // User v·ª´a b·ªã deactivate ‚Üí Hi·ªÉn th·ªã n√∫t Delete
                        if (!existingDeleteBtn) {
                            const deleteBtn = document.createElement("button");
                            deleteBtn.className = "btn btn-sm btn-danger btn-delete";
                            deleteBtn.innerHTML = "Delete";
                            deleteBtn.onclick = function () {
                                deleteUser(id, this);
                            };
                            actionBtnsContainer.appendChild(deleteBtn);
                        }
                    } else {
                        // User v·ª´a ƒë∆∞·ª£c activate ‚Üí ·∫®n n√∫t Delete
                        if (existingDeleteBtn) {
                            existingDeleteBtn.remove();
                        }
                    }

                    // 5. C·∫≠p nh·∫≠t th·ªëng k√™
                    updateUserStats();
                } else {
                    showNotification(await res.text(), "error");
                    btn.innerText = originalText;
                }
            } catch (e) {
                showNotification("Error connecting to server", "error");
                btn.innerText = originalText;
            } finally {
                btn.disabled = false;
            }
        }
        // SAVE USER
        // SAVE USER FUNCTION
        async function handleSaveUser(e) {
    e.preventDefault(); // kh√¥ng cho submit reload trang

    // 1. Validate
    if (!validateUserForm()) return;

    // 2. L·∫•y data t·ª´ form
    const form = document.getElementById("userForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Fix Checkbox & ID
    const isNew = !data.id; // true = th√™m m·ªõi, false = update
    data.resetPassword = document.getElementById("resetPassword").checked;
    if (!data.id) data.id = null;

    // 3. UI Feedback
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "Saving...";

    try {
        // 4. G·ª≠i request AJAX
        const res = await secureFetch(contextPath + "admin/users/save", {
            method: "POST",
            body: JSON.stringify(data),
        });

        if (res.ok) {
            showNotification(
                isNew ? "User created successfully" : "User updated successfully",
                "success"
            );
            closeUserModal();

            // üåü Quan tr·ªçng: ƒë·∫£m b·∫£o sau reload v·∫´n ·ªü tab Users
            localStorage.setItem("adminActiveTab", "users");

            // Reload l·∫°i trang ƒë·ªÉ load data m·ªõi
            setTimeout(() => location.reload(), 800);
        } else {
            const text = await res.text();
            showNotification(text || "Error saving user", "error");
        }
    } catch (err) {
        console.error(err);
        showNotification("System error occurred", "error");
    } finally {
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

        // UPDATE ROLE (AJAX)
        async function updateUserRole(userId, selectElement) {
            const newRoleCode = selectElement.value;
            const originalRole = selectElement.getAttribute("data-original-value");

            selectElement.disabled = true;

            try {
                const formData = new FormData();
                formData.append("roleCode", newRoleCode);

                const res = await secureFetch(
                    contextPath + `admin/users/${userId}/edit-role`,
                    {
                        method: "POST",
                        body: formData,
                    }
                );

                if (res.ok) {
                    const successMsg = await res.text();
                    showNotification(successMsg, "success");
                    selectElement.setAttribute("data-original-value", newRoleCode);

                    // C·∫≠p nh·∫≠t data-role ƒë·ªÉ stats ch√≠nh x√°c
                    selectElement.closest("tr").setAttribute("data-role", newRoleCode);
                    updateUserStats();
                } else {
                    const errorMsg = await res.text();
                    showNotification(errorMsg, "error");
                    selectElement.value = originalRole;
                }
            } catch (error) {
                console.error(error);
                showNotification("Connection error", "error");
                selectElement.value = originalRole;
            } finally {
                selectElement.disabled = false;
            }
        }

        // DELETE USER
        async function deleteUser(id, btn) {
            if (!confirm('‚ö†Ô∏è Delete this user permanently? This action cannot be undone!')) return;

            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '...';

            try {
                const res = await secureFetch(contextPath + `admin/users/${id}/delete`, { method: 'POST' });
                if (res.ok) {
                    showNotification('User deleted successfully', 'success');

                    // X√≥a row kh·ªèi b·∫£ng v·ªõi hi·ªáu ·ª©ng fade out
                    const tr = btn.closest('tr');
                    tr.style.transition = 'opacity 0.3s ease';
                    tr.style.opacity = '0';

                    setTimeout(() => {
                        tr.remove();
                        updateUserStats();
                    }, 300);

                } else {
                    showNotification(await res.text(), 'error');
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                showNotification('Error deleting user', 'error');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- 4. Helpers & Init ---
       document.addEventListener("DOMContentLoaded", () => {
    const navItems = document.querySelectorAll(".nav-item");
    const sections = document.querySelectorAll(".content-section");
    const pageTitleEl = document.getElementById("pageTitle");

    // H√†m k√≠ch ho·∫°t 1 tab + l∆∞u v√†o localStorage
    function activateTab(sectionId) {
        // clear tr·∫°ng th√°i c≈©
        navItems.forEach(n => n.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));

        // set active cho nav
        const activeNav = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
        if (activeNav) {
            activeNav.classList.add("active");
            if (pageTitleEl) {
                pageTitleEl.textContent = activeNav.textContent.trim();
            }
        }

        // set active cho section
        const activeSection = document.getElementById(sectionId);
        if (activeSection) {
            activeSection.classList.add("active");
        }

        // l∆∞u tab hi·ªán t·∫°i
        localStorage.setItem("adminActiveTab", sectionId);
    }

    // L·∫•y tab ƒë√£ l∆∞u, m·∫∑c ƒë·ªãnh l√† dashboard
    const savedTab = localStorage.getItem("adminActiveTab") || "dashboard";
    activateTab(savedTab);

    // G·∫Øn event click cho menu
    navItems.forEach((item) => {
        item.addEventListener("click", function (e) {
            e.preventDefault();
            const sectionId = this.dataset.section;
            if (sectionId) {
                activateTab(sectionId);
            }
        });
    });

    updateUserStats();

    // Email check
    const emailInput = document.getElementById("email");
    if (emailInput) {
        emailInput.addEventListener("blur", function () {
            const email = this.value;
            const id = document.getElementById("userId").value;
            if (!email) return;
            fetch(
                `${contextPath}admin/check-email?email=${encodeURIComponent(
                    email
                )}${id ? "&id=" + id : ""}`
            )
                .then((r) => r.json())
                .then((d) => {
                    const err = document.getElementById("emailError");
                    const btn = document.querySelector(
                        '#userModal button[type="submit"]'
                    );
                    if (d.exists) {
                        err.textContent = "Email exists";
                        btn.disabled = true;
                    } else {
                        err.textContent = "";
                        btn.disabled = false;
                    }
                });
        });
    }

    // Mobile dropdown toggle
    const dropdownToggle = document.querySelector(".dropdown-toggle");
    const dropdownMenu = document.querySelector(".dropdown-menu");

    if (dropdownToggle && dropdownMenu) {
        dropdownToggle.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle("show");
        });

        // Close when clicking outside
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".profile-dropdown")) {
                dropdownMenu.classList.remove("show");
            }
        });
    }
});

        function updateUserStats() {
            const rows = document.querySelectorAll("#users tbody tr");
            let active = 0,
                inactive = 0,
                admins = 0,
                staff = 0;

            rows.forEach((r) => {
                const isActive = r.getAttribute("data-active") === "true";
                const roleCode = r.getAttribute("data-role");

                if (isActive) active++;
                else inactive++;
                if (roleCode === "ROLE_ADMIN") admins++;
                if (roleCode === "ROLE_STAFF") staff++;
            });

            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = val;
            };
            set("totalUsersStat", rows.length);
            set("activeUsersStat", active);
            set("inactiveUsersStat", inactive);
            set("adminStaffStat", `${admins} admin / ${staff} staff`);
            set("headerActiveUsers", active);
            set("headerTotalUsers", rows.length);
        }

        // Modal Helpers
        document.getElementById("addUserBtn")?.addEventListener("click", () => {
            document.getElementById("userModalTitle").textContent = "Add User";
            document.getElementById("userForm").reset();
            document.getElementById("userId").value = "";
            document.getElementById("passwordGroup").style.display = "block";
            document.getElementById("resetPasswordGroup").style.display = "none";
            document.getElementById("password").required = true;
            document.getElementById("userModal").style.display = "flex";
        });

        function editUser(id) {
            fetch(contextPath + "admin/users/" + id)
                .then((r) => r.json())
                .then((u) => {
                    document.getElementById("userModalTitle").textContent = "Edit User";
                    document.getElementById("userId").value = u.id;
                    document.getElementById("fullName").value = u.fullName;
                    document.getElementById("email").value = u.email;
                    document.getElementById("roleCode").value = u.role.code;
                    document.getElementById("password").value = "";
                    document.getElementById("passwordGroup").style.display = "none";
                    document.getElementById("resetPasswordGroup").style.display =
                        "block";
                    document.getElementById("password").required = false;
                    document.getElementById("userModal").style.display = "flex";
                })
                .catch(() => showNotification("Error loading user", "error"));
        }

        function viewUser(id) {
            fetch(contextPath + "admin/users/" + id)
                .then((r) => r.json())
                .then((u) => {
                    document.getElementById("detailId").textContent = u.id;
                    document.getElementById("detailFullName").textContent = u.fullName;
                    document.getElementById("detailEmail").textContent = u.email;
                    document.getElementById("detailRole").textContent = u.role.name;
                    document.getElementById(
                        "detailActive"
                    ).innerHTML = `<span class="badge ${u.active ? "success" : "danger"
                    }">${u.active ? "Active" : "Inactive"}</span>`;
                    document.getElementById("userDetailModal").style.display = "flex";
                });
        }

        function closeUserModal() {
            document.getElementById("userModal").style.display = "none";
        }
        function closeUserDetailModal() {
            document.getElementById("userDetailModal").style.display = "none";
        }

        function validateUserForm() {
            const isNew = !document.getElementById("userId").value;
            const pwd = document.getElementById("password").value;
            const pattern = /^(?=.*[A-Z])(?=.*\d)(?=.*[@#$%^&+=!])(?=\S+$).{8,}$/;
            if ((isNew || pwd) && !pattern.test(pwd)) {
                showNotification("Password too weak!", "error");
                return false;
            }
            return true;
        }
    </script>
</body>

</html>