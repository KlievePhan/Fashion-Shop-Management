<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Shop Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<style>
    /* Badge Styles */
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge.success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .badge.danger {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .badge.warning {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fcd34d;
    }

    .badge.info {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
    }

    .changes-preview {
        display: inline-block;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: help;
        color: #6b7280;
        font-size: 13px;
    }

    .changes-preview:hover {
        color: #111827;
    }

    .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .filter-select {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        background-color: white;
        cursor: pointer;
        transition: border-color 0.3s;
    }

    .filter-select:hover {
        border-color: #9ca3af;
    }

    .filter-select:focus {
        outline: none;
        border-color: #dc2626;
    }

    .action-btns {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .action-btns form {
        margin: 0;
        display: inline-block;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
    }

    .btn-danger {
        background-color: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background-color: #991b1b;
    }

    .btn-primary {
        background-color: #dc2626;
        color: white;
    }

    .btn-primary:hover {
        background-color: #991b1b;
    }

    .btn-success {
        background-color: #059669;
        color: white;
    }

    .btn-success:hover {
        background-color: #047857;
    }

    .role-select {
        padding: 4px 8px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 13px;
        background-color: white;
        cursor: pointer;
    }

    @media (max-width: 1200px) {
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            min-width: 1000px;
        }
    }

    /* User Detail Modal */
    .user-detail-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .user-detail-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .user-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .user-detail-body {
        display: grid;
        gap: 15px;
    }

    .detail-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 15px;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .detail-label {
        font-weight: 600;
        color: #4b5563;
    }

    .detail-value {
        color: #111827;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #dc2626;
    }
</style>
<body>
<!-- Sidebar Navigation -->
<aside class="sidebar">
    <div class="logo">
        <h2>Fashion Shop</h2>
    </div>
    <nav class="nav-menu">
        <a href="#" class="nav-item active" data-section="dashboard">
            <span class="icon">üìä</span>
            Dashboard
        </a>
        <a href="#" class="nav-item" data-section="products">
            <span class="icon">üëï</span>
            Products
        </a>
        <a href="#" class="nav-item" data-section="brands">
            <span class="icon">üè∑Ô∏è</span>
            Brands
        </a>
        <a href="#" class="nav-item" data-section="orders">
            <span class="icon">üì¶</span>
            Orders
        </a>
        <a href="#" class="nav-item" data-section="users">
            <span class="icon">üë•</span>
            Users
        </a>
        <a href="#" class="nav-item" data-section="analytics">
            <span class="icon">üìà</span>
            Analytics
        </a>
        <a href="#" class="nav-item" data-section="auditlog">
            <span class="icon">üìã</span>
            Audit Log
        </a>
    </nav>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="header-title-section">
                <h1 id="pageTitle">Dashboard</h1>
                <p class="header-subtitle" id="headerSubtitle">Welcome back, Admin</p>
            </div>
        </div>
        <div class="header-right">
            <div class="status-info">
                <div class="status-item">
                    <span class="status-label">Total Orders Today</span>
                    <span class="status-value" id="ordersToday">12</span>
                </div>
                <div class="status-divider"></div>
                <div class="status-item">
                    <span class="status-label">Revenue Today</span>
                    <span class="status-value" id="revenueToday">$2,450</span>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" placeholder="Search products, orders..." id="searchInput">
                <i class="search-icon">üîç</i>
            </div>

            <div class="notifications">
                <button class="notification-btn" id="notificationBtn">
                    <i class="bell-icon">üîî</i>
                    <span class="notification-badge">3</span>
                </button>
            </div>

            <div class="user-profile">
                <div class="avatar">A</div>
                <div class="user-info">
                    <span class="user-name">Admin</span>
                    <span class="user-role">Administrator</span>
                </div>

                <div class="profile-dropdown">
                    <button class="dropdown-toggle">‚ãÆ</button>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item">
                            <i>üë§</i> Profile
                        </a>
                        <a href="#" class="dropdown-item">
                            <i>‚öôÔ∏è</i> Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <form th:action="@{/logout}" method="post" style="margin:0;">
                            <button type="submit" class="dropdown-item logout-item">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard Section -->
    <section id="dashboard" class="content-section active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon red">üí∞</div>
                <div class="stat-info">
                    <h3>Total Revenue</h3>
                    <p class="stat-value">$24,580</p>
                    <span class="stat-change positive">+12.5%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>Orders</h3>
                    <p class="stat-value">342</p>
                    <span class="stat-change positive">+8.2%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>Products</h3>
                    <p class="stat-value">156</p>
                    <span class="stat-change">0%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>Customers</h3>
                    <p class="stat-value">1,249</p>
                    <span class="stat-change positive">+15.3%</span>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Recent Orders</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                        <tr>
                            <td>#ORD-001</td>
                            <td>John Doe</td>
                            <td>$125.00</td>
                            <td><span class="badge success">Purchased</span></td>
                        </tr>
                        <tr>
                            <td>#ORD-002</td>
                            <td>Jane Smith</td>
                            <td>$89.50</td>
                            <td><span class="badge warning">Pending</span></td>
                        </tr>
                        <tr>
                            <td>#ORD-003</td>
                            <td>Mike Johnson</td>
                            <td>$245.00</td>
                            <td><span class="badge warning">Pending</span></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Top Products</h3>
                <div class="product-list">
                    <div class="product-item">
                        <span class="product-name">Classic T-Shirt</span>
                        <span class="product-sales">245 sales</span>
                    </div>
                    <div class="product-item">
                        <span class="product-name">Denim Jeans</span>
                        <span class="product-sales">198 sales</span>
                    </div>
                    <div class="product-item">
                        <span class="product-name">Leather Jacket</span>
                        <span class="product-sales">156 sales</span>
                    </div>
                    <div class="product-item">
                        <span class="product-name">Summer Dress</span>
                        <span class="product-sales">143 sales</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Products Section -->
    <section id="products" class="content-section">
        <div class="section-header">
            <h2>Products Management</h2>
            <div class="filter-group">
                <select class="filter-select" id="productCategoryFilter">
                    <option value="all">All Categories</option>
                    <option value="man">Man</option>
                    <option value="woman">Woman</option>
                    <option value="unisex">Unisex</option>
                </select>
            </div>
            <button class="btn btn-primary" id="addProductBtn">+ Add Product</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th style="display: none;">ID</th>
                        <th>SKU</th>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Brand</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    <tr th:each="product : ${products}">
                        <td style="display: none;" th:text="${product.id}"></td>
                        <td th:text="${product.sku}"></td>
                        <td>
                            <img th:src="${product.primaryImageUrl}"
                                 alt="Product"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                        </td>
                        <td th:text="${product.title}"></td>
                        <td th:text="${product.category != null ? product.category.name : 'N/A'}"></td>
                        <td th:text="${product.brand != null ? product.brand.name : 'N/A'}"></td>
                        <td th:text="'$' + ${product.basePrice}"></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${product.active ? 'success' : 'danger'}"
                                  th:text="${product.active ? 'Active' : 'Inactive'}"></span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        th:onclick="'editProduct(\'' + ${product.id} + '\')'">
                                    Edit
                                </button>
                                <form th:action="@{/admin/products/{id}/toggle-active(id=${product.id})}"
                                      method="post"
                                      style="display:inline;">
                                    <button type="submit"
                                            class="btn btn-sm"
                                            th:classappend="${product.active ? 'btn-warning' : 'btn-success'}">
                                        <span th:text="${product.active ? 'Deactivate' : 'Activate'}"></span>
                                    </button>
                                </form>
                                <form th:action="@{/admin/products/{id}/delete(id=${product.id})}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('Delete this product?')">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Brands Section -->
    <section id="brands" class="content-section">
        <div class="section-header">
            <h2>Brand Management</h2>
            <button class="btn btn-primary" id="addBrandBtn">+ Add Brand</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Slug</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="brand : ${brands}">
                        <td th:text="${brand.id}"></td>
                        <td th:text="${brand.name}"></td>
                        <td th:text="${brand.slug}"></td>
                        <td th:text="${#temporals.format(brand.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm btn-secondary" th:onclick="'editBrand(' + ${brand.id} + ')'">Edit</button>
                                <form th:action="@{/admin/brand/{id}/delete(id=${brand.id})}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this brand?')">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Orders Section -->
    <section id="orders" class="content-section">
        <div class="section-header">
            <h2>Orders Management</h2>
            <div class="filter-group">
                <select class="filter-select" id="orderStatus">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Users Section -->
    <section id="users" class="content-section">
        <div class="section-header">
            <h2>Users Management</h2>
            <button class="btn btn-primary" id="addUserBtn">+ Add User</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user : ${users}">
                        <td th:text="${user.id}"></td>
                        <td th:text="${user.fullName}"></td>
                        <td th:text="${user.email}"></td>
                        <td>
                            <form th:action="@{/admin/users/{id}/edit-role(id=${user.id})}" method="post" style="display:inline;">
                                <select name="roleCode" class="role-select" th:disabled="${user.id == currentUserId}">
                                    <option th:each="role : ${roles}"
                                            th:value="${role.code}"
                                            th:text="${role.name}"
                                            th:selected="${user.role.code == role.code}">
                                    </option>
                                </select>
                                <button type="submit"
                                        class="btn btn-sm btn-primary"
                                        th:disabled="${user.id == currentUserId}"
                                        style="margin-left: 5px;">
                                    Update
                                </button>
                            </form>
                        </td>
                        <td>
                            <span class="badge" th:classappend="${user.active ? 'success' : 'danger'}"
                                  th:text="${user.active ? 'Active' : 'Inactive'}"></span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm btn-secondary" th:onclick="'viewUser(' + ${user.id} + ')'">View</button>
                                <button class="btn btn-sm btn-secondary"
                                        th:onclick="'editUser(' + ${user.id} + ')'"
                                        th:disabled="${user.id == currentUserId}">
                                    Edit
                                </button>
                                <form th:action="@{/admin/users/{id}/toggle-active(id=${user.id})}" method="post" style="display:inline;">
                                    <button type="submit"
                                            class="btn btn-sm"
                                            th:classappend="${user.active ? 'btn-danger' : 'btn-success'}"
                                            th:disabled="${user.id == currentUserId}">
                                        <span th:text="${user.active ? 'Deactivate' : 'Activate'}"></span>
                                    </button>
                                </form>
                                <form th:if="${!user.active}"
                                      th:action="@{/admin/users/{id}/delete(id=${user.id})}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('Are you sure you want to permanently delete this user? This action cannot be undone.');">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Analytics Section -->
    <section id="analytics" class="content-section">
        <div class="section-header">
            <h2>Analytics</h2>
        </div>

        <div class="analytics-grid">
            <div class="card">
                <h3>Sales Overview</h3>
                <div class="chart-placeholder">
                    <p>üìà Sales chart visualization</p>
                    <p class="chart-note">Connect to your Spring Boot backend to display real-time data</p>
                </div>
            </div>
            <div class="card">
                <h3>Category Distribution</h3>
                <div class="category-stats">
                    <div class="category-item">
                        <span class="category-name">T-Shirts</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 45%"></div>
                        </div>
                        <span class="category-percent">45%</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Jeans</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 30%"></div>
                        </div>
                        <span class="category-percent">30%</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Jackets</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 15%"></div>
                        </div>
                        <span class="category-percent">15%</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Accessories</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 10%"></div>
                        </div>
                        <span class="category-percent">10%</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Audit Log Section -->
    <section id="auditlog" class="content-section">
        <div class="section-header">
            <h2>Audit Log</h2>
            <div class="filter-group">
                <select class="filter-select" id="auditAction">
                    <option value="all">All Actions</option>
                    <option value="CREATE">Create</option>
                    <option value="UPDATE">Update</option>
                    <option value="DELETE">Delete</option>
                    <option value="VIEW">View</option>
                </select>
                <select class="filter-select" id="auditEntity">
                    <option value="all">All Entities</option>
                    <option value="Product">Product</option>
                    <option value="Brand">Brand</option>
                    <option value="Order">Order</option>
                    <option value="User">User</option>
                </select>
                <input type="date" class="filter-select" id="auditDate">
            </div>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Actor</th>
                        <th>Role</th>
                        <th>Action</th>
                        <th>Entity</th>
                        <th>Changes</th>
                        <th>Timestamp</th>
                    </tr>
                    </thead>
                    <tbody id="auditLogTable">
                    <tr th:each="log : ${auditLogs}">
                        <td th:text="${log.id}"></td>
                        <td th:text="${log.actor != null ? log.actor.fullName : 'System'}"></td>
                        <td th:text="${log.actorRole}"></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${log.action == 'CREATE' ? 'success' : (log.action == 'DELETE' ? 'danger' : (log.action == 'UPDATE' ? 'warning' : 'info'))}"
                                  th:text="${log.action}"></span>
                        </td>
                        <td th:text="${log.entity}"></td>
                        <td>
                            <span class="changes-preview" th:title="${log.changes}" th:text="${#strings.abbreviate(log.changes, 50)}"></span>
                        </td>
                        <td th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<!-- Modal for Add/Edit Brand -->
<div id="brandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="brandModalTitle">Add New Brand</h2>
            <button class="close-modal" onclick="closeBrandModal()">&times;</button>
        </div>
        <form th:action="@{/admin/brand/save}" method="post" id="brandForm">
            <input type="hidden" id="brandId" name="id">
            <div class="form-group">
                <label>Brand Name</label>
                <input type="text" id="brandName" name="name" required maxlength="150" placeholder="e.g., Nike, Adidas">
            </div>
            <div class="form-group">
                <label>Slug</label>
                <input type="text" id="brandSlug" name="slug" required maxlength="150" placeholder="e.g., nike, adidas">
                <small style="color: #6b7280; font-size: 12px;">URL-friendly version (lowercase, no spaces)</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal" onclick="closeBrandModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Brand</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for Add/Edit User -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="userModalTitle">Add New User</h2>
            <button class="close-modal" onclick="closeUserModal()">&times;</button>
        </div>
        <form th:action="@{/admin/users/save}" method="post" id="userForm">
            <input type="hidden" id="userId" name="id">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" name="fullName" required maxlength="255" placeholder="e.g., John Doe">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" name="email" required maxlength="255" placeholder="e.g., john@example.com">
            </div>
            <div class="form-group">
                <label>Password <span id="passwordHint" style="color: #6b7280; font-size: 12px;">(required for new users)</span></label>
                <input type="password" id="password" name="password" placeholder="Leave blank to keep current">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="roleCode" name="roleCode" required>
                    <option th:each="role : ${roles}"
                            th:value="${role.code}"
                            th:text="${role.name}">
                    </option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal" onclick="closeUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save User</button>
            </div>
        </form>
    </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="user-detail-modal">
    <div class="user-detail-content">
        <div class="user-detail-header">
            <h2>User Details</h2>
            <button class="close-btn" onclick="closeUserDetailModal()">&times;</button>
        </div>
        <div class="user-detail-body">
            <div class="detail-row">
                <div class="detail-label">ID:</div>
                <div class="detail-value" id="detailId"></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Full Name:</div>
                <div class="detail-value" id="detailFullName"></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Email:</div>
                <div class="detail-value" id="detailEmail"></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Role:</div>
                <div class="detail-value" id="detailRole"></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status:</div>
                <div class="detail-value" id="detailActive"></div>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="productModalTitle">Add New Product</h2>
            <button class="close-modal" onclick="closeProductModal()">&times;</button>
        </div>
        <form th:action="@{/admin/products/save}" method="post" id="productForm">
            <input type="hidden" id="productId" name="id">

            <div class="form-row">
                <div class="form-group">
                    <label>SKU *</label>
                    <input type="text" id="productSku" name="sku" required placeholder="e.g., TS-001">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="productActive" name="active">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Product Title *</label>
                <input type="text" id="productTitle" name="title" required placeholder="e.g., Classic T-Shirt">
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" name="description" rows="3"
                          placeholder="Product description..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Category *</label>
                    <select id="productCategoryId" name="categoryId" required>
                        <option value="">Select Category</option>
                        <option th:each="cat : ${categories}"
                                th:value="${cat.id}"
                                th:text="${cat.name}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Brand</label>
                    <select id="productBrandId" name="brandId">
                        <option value="">Optional</option>
                        <option th:each="brand : ${brands}"
                                th:value="${brand.id}"
                                th:text="${brand.name}"></option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Base Price ($) *</label>
                <input type="number" id="productPrice" name="basePrice" step="0.01" min="0" required placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Image URLs (comma-separated)</label>
                <textarea id="productImageUrls" name="imageUrls" rows="2"
                          placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg"></textarea>
                <small style="color: #6b7280;">First image will be primary</small>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Product</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    const contextPath = /*[[@{/}]]*/ '/';

    // ============= Navigation =============
    document.addEventListener('DOMContentLoaded', function() {
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.content-section');
        const pageTitle = document.getElementById('pageTitle');

        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const targetSection = this.dataset.section;

                // Update active states
                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                // Show target section
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById(targetSection).classList.add('active');

                // Update title
                pageTitle.textContent = this.textContent.trim();
            });
        });
    });

    function editBrand(id) {
        fetch(contextPath + 'admin/brand/' + id, {
            headers: {
                'Accept': 'application/json'   // <-- THIS IS THE KEY
            }
        })
            .then(response => {
                if (!response.ok) {
                    // 404 ‚Üí brand not found
                    throw new Error('Brand not found (HTTP ' + response.status + ')');
                }
                return response.json();
            })
            .then(brand => {
                // ---- Fill the modal ----
                document.getElementById('brandModalTitle').textContent = 'Edit Brand';
                document.getElementById('brandId').value      = brand.id;
                document.getElementById('brandName').value    = brand.name;
                document.getElementById('brandSlug').value    = brand.slug;

                // ---- Show the modal ----
                document.getElementById('brandModal').style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                alert('Failed to load brand: ' + err.message);
            });
    }

    /* ---------- 1. OPEN ADD PRODUCT MODAL ---------- */
    document.getElementById('addProductBtn')?.addEventListener('click', function () {
        document.getElementById('productModalTitle').textContent = 'Add New Product';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productModal').classList.add('active');
    });

    /* ---------- 2. EDIT PRODUCT (AJAX ‚Üí JSON) ---------- */
    function editProduct(id) {
        fetch(contextPath + 'admin/products/' + id, {
            headers: { 'Accept': 'application/json' }
        })
            .then(r => {
                if (!r.ok) throw new Error('Product not found ‚Äì HTTP ' + r.status);
                return r.json();
            })
            .then(p => {
                // Title
                document.getElementById('productModalTitle').textContent = 'Edit Product';

                // Basic fields
                document.getElementById('productId').value          = p.id;
                document.getElementById('productSku').value         = p.sku || '';
                document.getElementById('productTitle').value       = p.title || '';
                document.getElementById('productDescription').value = p.description || '';
                document.getElementById('productCategoryId').value  = p.category?.id || '';
                document.getElementById('productBrandId').value     = p.brand?.id || '';
                document.getElementById('productPrice').value       = p.basePrice || '';
                document.getElementById('productActive').value      = p.active ? 'true' : 'false';

                // Images ‚Äì comma separated
                const imgs = p.images ? p.images.map(i => i.url).join(', ') : '';
                document.getElementById('productImageUrls').value = imgs;

                // Show modal (same CSS class used everywhere)
                document.getElementById('productModal').classList.add('active');
            })
            .catch(err => {
                console.error(err);
                alert('Failed to load product: ' + err.message);
            });
    }

    /* ---------- 3. CLOSE MODAL ---------- */
    function closeProductModal() {
        document.getElementById('productModal').classList.remove('active');
    }

    /* ---------- 4. GLOBAL EXPORTS (used by th:onclick) ---------- */
    window.editProduct      = editProduct;
    window.closeProductModal = closeProductModal;

    /* ---------- 5. CATEGORY FILTER (tiny improvement) ---------- */
    document.getElementById('productCategoryFilter')?.addEventListener('change', function (e) {
        const cat = e.target.value;

        if (cat === 'all') {
            location.href = contextPath + 'admin#products';
            return;
        }

        fetch(contextPath + 'admin/products/filter?category=' + cat, {
            headers: { 'Accept': 'application/json' }
        })
            .then(r => r.json())
            .then(list => {
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = list.map(p => `
                <tr>
                    <td style="display: none;">${p.id}</td>
                    <td>${p.sku || 'N/A'}</td>
                    <td>
                        <img src="${p.primaryImageUrl || '/images/default.jpg'}"
                             style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                    </td>
                    <td>${p.title}</td>
                    <td>${p.category ? p.category.name : 'N/A'}</td>
                    <td>${p.brand ? p.brand.name : 'N/A'}</td>
                    <td>$${p.basePrice}</td>
                    <td>
                        <span class="badge ${p.active ? 'success' : 'danger'}">
                            ${p.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="action-btns">
                            <button type="button" class="btn btn-sm btn-secondary"
                                   onclick="editProduct('${p.id}')">Edit</button>

                            <form action="${contextPath}admin/products/${p.id}/toggle-active"
                                  method="post" style="display:inline;">
                                <button type="submit"
                                        class="btn btn-sm ${p.active ? 'btn-warning' : 'btn-success'}">
                                    ${p.active ? 'Deactivate' : 'Activate'}
                                </button>
                            </form>

                            <form action="${contextPath}admin/products/${p.id}/delete"
                                  method="post" style="display:inline;"
                                  onsubmit="return confirm('Delete this product?')">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
            `).join('');
            })
            .catch(err => console.error(err));
    });
</script>
<script th:src="@{/js/admin.js}"></script>
<script>
    // Brand Management Functions
    document.getElementById('addBrandBtn')?.addEventListener('click', function() {
        document.getElementById('brandModalTitle').textContent = 'Add New Brand';
        document.getElementById('brandForm').reset();
        document.getElementById('brandId').value = '';
        document.getElementById('brandModal').style.display = 'flex';
    });

    function closeBrandModal() {
        document.getElementById('brandModal').style.display = 'none';
    }

    document.getElementById('brandName')?.addEventListener('input', function(e) {
        const slug = e.target.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        document.getElementById('brandSlug').value = slug;
    });

    window.addEventListener('click', function(e) {
        const brandModal = document.getElementById('brandModal');
        if (e.target === brandModal) {
            closeBrandModal();
        }
    });

    // User Management Functions
    document.getElementById('addUserBtn')?.addEventListener('click', function() {
        document.getElementById('userModalTitle').textContent = 'Add New User';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('passwordHint').textContent = '(required for new users)';
        document.getElementById('password').required = true;
        document.getElementById('userModal').style.display = 'flex';
    });

    function editUser(id) {
        fetch(`/admin/users/${id}`)
            .then(response => response.json())
            .then(user => {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userId').value = user.id;
                document.getElementById('fullName').value = user.fullName;
                document.getElementById('email').value = user.email;
                document.getElementById('password').value = '';
                document.getElementById('password').required = false;
                document.getElementById('passwordHint').textContent = '(leave blank to keep current)';
                document.getElementById('roleCode').value = user.role.code;
                document.getElementById('userModal').style.display = 'flex';
            })
            .catch(error => {
                alert('Error loading user data');
                console.error(error);
            });
    }

    function viewUser(id) {
        fetch(`/admin/users/${id}`)
            .then(response => response.json())
            .then(user => {
                document.getElementById('detailId').textContent = user.id;
                document.getElementById('detailFullName').textContent = user.fullName;
                document.getElementById('detailEmail').textContent = user.email;
                document.getElementById('detailRole').textContent = user.role.name + ' (' + user.role.code + ')';

                const activeSpan = document.createElement('span');
                activeSpan.className = 'badge ' + (user.active ? 'success' : 'danger');
                activeSpan.textContent = user.active ? 'Active' : 'Inactive';
                document.getElementById('detailActive').innerHTML = '';
                document.getElementById('detailActive').appendChild(activeSpan);

                document.getElementById('userDetailModal').style.display = 'flex';
            })
            .catch(error => {
                alert('Error loading user data');
                console.error(error);
            });
    }

    function closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    function closeUserDetailModal() {
        document.getElementById('userDetailModal').style.display = 'none';
    }

    window.addEventListener('click', function(e) {
        const userModal = document.getElementById('userModal');
        const userDetailModal = document.getElementById('userDetailModal');

        if (e.target === userModal) {
            closeUserModal();
        }
        if (e.target === userDetailModal) {
            closeUserDetailModal();
        }
    });

    // Display flash messages
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');

        if (success) {
            showNotification(success, 'success');
        }
        if (error) {
            showNotification(error, 'error');
        }
    });

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, ${type === 'success' ? '#059669, #047857' : '#dc2626, #991b1b'});
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(${type === 'success' ? '5, 150, 105' : '220, 38, 38'}, 0.4);
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
</script>
</body>

</html>