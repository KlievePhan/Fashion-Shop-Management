<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Fashion Shop</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Lato', sans-serif;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .checkout-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .checkout-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .checkout-steps {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #999;
        }

        .step.active {
            color: #000;
            font-weight: 600;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step.active .step-number {
            background: #000;
            color: #fff;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .checkout-form,
        .order-summary {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #000;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .order-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .item-details {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .item-options {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .item-price {
            font-size: 14px;
            color: #666;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 15px;
        }

        .summary-row.total {
            border-top: 2px solid #e0e0e0;
            padding-top: 15px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .payment-methods {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: #000;
        }

        .payment-method input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-method img {
            height: 32px;
        }

        .btn-checkout {
            width: 100%;
            padding: 16px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-checkout:hover {
            background: #333;
        }

        .btn-checkout:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-danger {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
        }

        @media (max-width: 992px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }

            .order-summary {
                order: -1;
            }
        }
    </style>
</head>

<body>
<div th:insert="~{header}"></div>

<div class="checkout-container">
    <!-- Header -->
    <div class="checkout-header">
        <h1>Checkout</h1>
        <div class="checkout-steps">
            <div class="step">
                <span class="step-number">1</span>
                <span>Cart</span>
            </div>
            <div class="step active">
                <span class="step-number">2</span>
                <span>Checkout</span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span>Payment</span>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div th:if="${param.error}" class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i>
        <span th:text="${param.error}">Error occurred</span>
    </div>

    <!-- Checkout Grid -->
    <div class="checkout-grid">
        <!-- Left: Checkout Form -->
        <div class="checkout-form">
            <h2 class="section-title">Shipping Information</h2>

            <form th:action="@{/checkout/create-payment}" method="post" id="checkoutForm">
                <!-- Full Name -->
                <div class="form-group">
                    <label for="fullName">Full Name <span style="color:red;">*</span></label>
                    <input type="text"
                           id="fullName"
                           name="fullName"
                           required
                           th:value="${user.fullName ?: user.displayName}"
                           placeholder="Enter your full name">
                </div>

                <!-- Phone -->
                <div class="form-group">
                    <label for="phone">Phone Number <span style="color:red;">*</span></label>
                    <input type="tel"
                           id="phone"
                           name="phone"
                           required
                           th:value="${user.phone}"
                           placeholder="Enter your phone number">
                </div>

                <!-- Address -->
                <div class="form-group">
                    <label for="address">Shipping Address <span style="color:red;">*</span></label>
                    <textarea id="address"
                              name="address"
                              required
                              placeholder="Enter your full address"
                              th:text="${user.defaultAddress}"></textarea>
                </div>

                <!-- Notes (Optional) -->
                <div class="form-group">
                    <label for="notes">Order Notes (Optional)</label>
                    <textarea id="notes"
                              name="notes"
                              placeholder="Notes about your order, e.g. special delivery instructions"></textarea>
                </div>

                <!-- Payment Methods -->
                <h2 class="section-title" style="margin-top:30px;">Payment Method</h2>
                <div class="payment-methods">
                    <!-- VNPay -->
                    <label class="payment-method" onclick="selectPaymentMethod('vnpay')">
                        <input type="radio" name="paymentMethod" value="vnpay" id="vnpayRadio">
                        <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/9/06ncktiwd6dc1694418196384.png" alt="VNPay">
                        <div>
                            <div style="font-weight:600;">VNPay</div>
                            <div style="font-size:13px;color:#666;">Pay online via VNPay gateway</div>
                        </div>
                    </label>

                    <!-- COD -->
                    <label class="payment-method" style="margin-top:12px;" onclick="selectPaymentMethod('cod')">
                        <input type="radio" name="paymentMethod" value="cod" id="codRadio" checked>
                        <i class="bi bi-cash-coin" style="font-size:32px;color:#28a745;"></i>
                        <div>
                            <div style="font-weight:600;">Cash on Delivery (COD)</div>
                            <div style="font-size:13px;color:#666;">Pay when you receive the goods</div>
                        </div>
                    </label>
                </div>

                <!-- COD Info Box -->
                <div id="codInfoBox" style="display:block;margin-top:15px;padding:15px;background:#e7f3ff;border-left:4px solid #007bff;border-radius:6px;">
                    <div style="display:flex;gap:10px;align-items:start;">
                        <i class="bi bi-info-circle" style="color:#007bff;font-size:20px;"></i>
                        <div style="font-size:14px;color:#004085;">
                            <strong>Cash on Delivery:</strong> You will pay when receiving the goods.
                            Please ensure your delivery information is accurate.
                        </div>
                    </div>
                </div>

                <!-- VNPay Info Box -->
                <div id="vnpayInfoBox" style="display:none;margin-top:15px;padding:15px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:6px;">
                    <div style="display:flex;gap:10px;align-items:start;">
                        <i class="bi bi-shield-check" style="color:#856404;font-size:20px;"></i>
                        <div style="font-size:14px;color:#856404;">
                            <strong>VNPay Payment:</strong> You will be redirected to VNPay gateway to complete the payment.
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-checkout" id="checkoutBtn">
                    <i class="bi bi-lock-fill"></i> <span id="btnText">Place Order</span>
                </button>
            </form>
        </div>

        <!-- Right: Order Summary -->
        <div class="order-summary">
            <h2 class="section-title">Order Summary</h2>

            <!-- Order Items -->
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <div class="order-item" th:each="item : ${cartItems}">
                    <img th:src="${item.product.primaryImageUrl}"
                         th:alt="${item.product.title}"
                         class="item-image">
                    <div class="item-details">
                        <div class="item-title" th:text="${item.product.title}">Product</div>
                        <div class="item-options">
                            <span th:if="${item.selectedSize}">Size: <strong th:text="${item.selectedSize}"></strong></span>
                            <span th:if="${item.selectedColor}"> | Color: <strong th:text="${item.selectedColor}"></strong></span>
                        </div>
                        <div class="item-price">
                            <span th:text="${item.qty} + ' x $' + ${#numbers.formatDecimal(item.unitPrice, 1, 2)}">1 x $0.00</span>
                        </div>
                    </div>
                    <div style="font-weight:600;">
                        <span th:text="'$' + ${#numbers.formatDecimal(item.lineTotal, 1, 2)}">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="summary-row">
                <span>Subtotal:</span>
                <span th:text="'$' + ${#numbers.formatDecimal(subtotal, 1, 2)}">$0.00</span>
            </div>

            <div class="summary-row">
                <span>Shipping:</span>
                <span th:text="'$' + ${#numbers.formatDecimal(shipping, 1, 2)}">$0.00</span>
            </div>

            <div class="summary-row">
                <span>Tax (10%):</span>
                <span th:text="'$' + ${#numbers.formatDecimal(tax, 1, 2)}">$0.00</span>
            </div>

            <div class="summary-row total">
                <span>Total:</span>
                <span th:text="'$' + ${#numbers.formatDecimal(total, 1, 2)}">$0.00</span>
            </div>

            <!-- Security Note -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #666;">
                <i class="bi bi-shield-check" style="color: #28a745;"></i>
                Your payment information is secure and encrypted.
            </div>
        </div>
    </div>
</div>

<div th:replace="~{footer :: footer}"></div>

<script th:src="@{/js/header.js}"></script>

<script>
    // Payment method selection
    let selectedPaymentMethod = 'cod'; // Default to COD

    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;

        // Update radio buttons
        document.getElementById('vnpayRadio').checked = (method === 'vnpay');
        document.getElementById('codRadio').checked = (method === 'cod');

        // Toggle info boxes
        document.getElementById('vnpayInfoBox').style.display = method === 'vnpay' ? 'block' : 'none';
        document.getElementById('codInfoBox').style.display = method === 'cod' ? 'block' : 'none';

        // Update button text
        const btnText = document.getElementById('btnText');
        const checkoutBtn = document.getElementById('checkoutBtn');

        if (method === 'vnpay') {
            btnText.innerHTML = 'Proceed to Payment';
            checkoutBtn.innerHTML = '<i class="bi bi-credit-card"></i> ' + btnText.outerHTML;
        } else {
            btnText.innerHTML = 'Place Order';
            checkoutBtn.innerHTML = '<i class="bi bi-check-circle"></i> ' + btnText.outerHTML;
        }
    }

    // Form validation and submission
    document.getElementById('checkoutForm')?.addEventListener('submit', (e) => {
        e.preventDefault();

        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();

        if (!fullName || !phone || !address) {
            alert('Please fill in all required fields');
            return false;
        }

        // Phone validation (basic)
        if (!/^[0-9]{10,11}$/.test(phone.replace(/\s/g, ''))) {
            alert('Please enter a valid phone number (10-11 digits)');
            return false;
        }

        // Show loading state
        const btn = document.getElementById('checkoutBtn');
        btn.disabled = true;

        if (selectedPaymentMethod === 'vnpay') {
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Redirecting to VNPay...</span>';
        } else {
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Processing Order...</span>';
        }

        // Submit form
        e.target.submit();
    });

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        selectPaymentMethod('cod');
    });
</script>
</body>
</html>