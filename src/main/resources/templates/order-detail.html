<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Details - Fashion Shop</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Lato', sans-serif;
        }

        .order-detail-container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 600;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #000;
        }

        .order-header-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .order-header-top {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .order-code {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .order-date {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .order-status {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.pending { background: #fff3e0; color: #f57c00; }
        .order-status.cod-pending { background: #e3f2fd; color: #1976d2; }
        .order-status.paid { background: #e8f5e9; color: #388e3c; }
        .order-status.shipped { background: #f3e5f5; color: #7b1fa2; }
        .order-status.delivered { background: #e0f2f1; color: #00796b; }
        .order-status.cancelled { background: #ffebee; color: #c62828; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .info-icon {
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
        }

        .info-content h4 {
            font-size: 13px;
            color: #666;
            margin: 0 0 5px 0;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-content p {
            margin: 0;
            color: #1a1a1a;
            font-weight: 600;
        }

        .timeline-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #1a1a1a;
        }

        .timeline {
            position: relative;
            padding-left: 50px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 30px;
            bottom: 30px;
            width: 2px;
            background: #e0e0e0;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -30px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: #fff;
            border: 3px solid #e0e0e0;
            z-index: 1;
        }

        .timeline-item.active .timeline-dot {
            background: #28a745;
            border-color: #28a745;
            color: #fff;
        }

        .timeline-content h4 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 5px 0;
            color: #1a1a1a;
        }

        .timeline-content p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        .items-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .order-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .order-item:last-child {
            margin-bottom: 0;
        }

        .item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            background: #fff;
        }

        .item-details {
            flex: 1;
        }

        .item-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .item-options {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .item-price {
            font-size: 14px;
            color: #666;
        }

        .item-total {
            text-align: right;
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .summary-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row.total {
            border-top: 2px solid #e0e0e0;
            padding-top: 15px;
            margin-top: 10px;
            font-size: 20px;
            font-weight: 700;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #000;
            color: #fff;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-outline {
            background: #fff;
            color: #000;
            border: 2px solid #000;
        }

        .btn-outline:hover {
            background: #f8f9fa;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .order-header-top {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .order-item {
                flex-direction: column;
            }

            .item-total {
                text-align: left;
            }
        }
    </style>
</head>

<body>
<div th:insert="~{header}"></div>

<div class="order-detail-container">
    <!-- Back Link -->
    <a th:href="@{/orders}" class="back-link">
        <i class="bi bi-arrow-left"></i> Back to Orders
    </a>

    <!-- Order Header Card -->
    <div class="order-header-card">
        <div class="order-header-top">
            <div>
                <div class="order-code" th:text="'Order #' + ${order.orderCode}">Order #ORD123</div>
                <div class="order-date" th:text="'Placed on ' + ${#temporals.format(order.createdAt, 'dd MMMM yyyy, HH:mm')}">
                    Placed on 26 November 2025, 14:30
                </div>
            </div>
            <span class="order-status"
                  th:classappend="${order.status.toLowerCase().replace('_', '-')}"
                  th:text="${order.status.replace('_', ' ')}">PENDING</span>
        </div>

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-item">
                <div class="info-icon">
                    <i class="bi bi-geo-alt"></i>
                </div>
                <div class="info-content">
                    <h4>Shipping Address</h4>
                    <p th:text="${order.address}">123 Street, City</p>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="bi bi-telephone"></i>
                </div>
                <div class="info-content">
                    <h4>Phone Number</h4>
                    <p th:text="${order.phone}">0123456789</p>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="info-content">
                    <h4>Payment Method</h4>
                    <p th:text="${order.status == 'COD_PENDING' || order.status == 'COD' ? 'Cash on Delivery' : 'VNPay'}">
                        VNPay
                    </p>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="bi bi-calendar"></i>
                </div>
                <div class="info-content">
                    <h4>Last Updated</h4>
                    <p th:text="${#temporals.format(order.updatedAt, 'dd MMM yyyy')}">26 Nov 2025</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Card -->
    <div class="timeline-card">
        <h2 class="card-title"><i class="bi bi-clock-history"></i> Order Timeline</h2>
        <div class="timeline">
            <div class="timeline-item active">
                <div class="timeline-dot">
                    <i class="bi bi-check-lg"></i>
                </div>
                <div class="timeline-content">
                    <h4>Order Placed</h4>
                    <p th:text="${#temporals.format(order.createdAt, 'dd MMM yyyy, HH:mm')}">26 Nov 2025, 14:30</p>
                </div>
            </div>

            <div class="timeline-item"
                 th:classappend="${order.status == 'PAID' || order.status == 'SHIPPED' || order.status == 'DELIVERED' ? 'active' : ''}">
                <div class="timeline-dot">
                    <i class="bi bi-check-lg"></i>
                </div>
                <div class="timeline-content">
                    <h4>Payment Confirmed</h4>
                    <p th:if="${order.status == 'PAID' || order.status == 'SHIPPED' || order.status == 'DELIVERED'}"
                       th:text="${#temporals.format(order.updatedAt, 'dd MMM yyyy, HH:mm')}">Pending</p>
                    <p th:unless="${order.status == 'PAID' || order.status == 'SHIPPED' || order.status == 'DELIVERED'}">
                        Waiting for payment confirmation
                    </p>
                </div>
            </div>

            <div class="timeline-item"
                 th:classappend="${order.status == 'SHIPPED' || order.status == 'DELIVERED' ? 'active' : ''}">
                <div class="timeline-dot">
                    <i class="bi bi-check-lg"></i>
                </div>
                <div class="timeline-content">
                    <h4>Order Shipped</h4>
                    <p th:if="${order.status == 'SHIPPED' || order.status == 'DELIVERED'}">
                        Your order is on the way
                    </p>
                    <p th:unless="${order.status == 'SHIPPED' || order.status == 'DELIVERED'}">
                        Waiting to be shipped
                    </p>
                </div>
            </div>

            <div class="timeline-item"
                 th:classappend="${order.status == 'DELIVERED' ? 'active' : ''}">
                <div class="timeline-dot">
                    <i class="bi bi-check-lg"></i>
                </div>
                <div class="timeline-content">
                    <h4>Delivered</h4>
                    <p th:if="${order.status == 'DELIVERED'}">
                        Order has been delivered successfully
                    </p>
                    <p th:unless="${order.status == 'DELIVERED'}">
                        Waiting for delivery
                    </p>
                </div>
            </div>

            <div class="timeline-item"
                 th:if="${order.status == 'CANCELLED'}"
                 th:classappend="'active'">
                <div class="timeline-dot" style="background: #dc3545; border-color: #dc3545;">
                    <i class="bi bi-x-lg"></i>
                </div>
                <div class="timeline-content">
                    <h4 style="color: #dc3545;">Order Cancelled</h4>
                    <p th:text="${#temporals.format(order.updatedAt, 'dd MMM yyyy, HH:mm')}">Cancelled</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Items Card -->
    <div class="items-card">
        <h2 class="card-title"><i class="bi bi-bag"></i> Order Items</h2>

        <div class="order-item" th:each="item : ${orderItems}">
            <img th:src="${item.product.primaryImageUrl}"
                 th:alt="${item.productTitle}"
                 class="item-image">

            <div class="item-details">
                <div class="item-title" th:text="${item.productTitle}">Product Name</div>
                <div class="item-options">
            <span th:if="${item.selectedOptions != null}"
                  class="options-display"
                  th:attr="data-options=${item.selectedOptions}"></span>
                </div>
                <div class="item-price">
            <span th:text="${item.qty} + ' x $' + ${#numbers.formatDecimal(item.unitPrice, 1, 2)}">
              1 x $0.00
            </span>
                </div>
            </div>

            <div class="item-total">
                <span th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">$0.00</span>
            </div>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="summary-card">
        <h2 class="card-title"><i class="bi bi-receipt"></i> Order Summary</h2>

        <div class="summary-row">
            <span>Subtotal:</span>
            <span th:text="'$' + ${#numbers.formatDecimal(order.totalAmount - order.shippingAmount - (order.totalAmount - order.shippingAmount) * 0.1, 1, 2)}">
          $0.00
        </span>
        </div>

        <div class="summary-row">
            <span>Shipping:</span>
            <span th:text="'$' + ${#numbers.formatDecimal(order.shippingAmount, 1, 2)}">$0.00</span>
        </div>

        <div class="summary-row">
            <span>Tax (10%):</span>
            <span th:text="'$' + ${#numbers.formatDecimal((order.totalAmount - order.shippingAmount) * 0.1, 1, 2)}">
          $0.00
        </span>
        </div>

        <div class="summary-row total">
            <span>Total:</span>
            <span th:text="'$' + ${#numbers.formatDecimal(order.totalAmount, 1, 2)}">$0.00</span>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" th:onclick="'reorder(' + ${order.id} + ')'">
                <i class="bi bi-arrow-repeat"></i> Re-order
            </button>

            <button class="btn btn-outline" onclick="window.print()">
                <i class="bi bi-printer"></i> Print Invoice
            </button>

            <button class="btn btn-danger"
                    th:if="${order.status == 'PENDING' || order.status == 'COD_PENDING'}"
                    th:onclick="'cancelOrder(' + ${order.id} + ')'">
                <i class="bi bi-x-circle"></i> Cancel Order
            </button>
        </div>
    </div>
</div>

<div th:replace="~{footer :: footer}"></div>

<script th:src="@{/js/header.js}"></script>

<script>
    // Parse selected options JSON
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.options-display').forEach(el => {
            try {
                const options = JSON.parse(el.dataset.options || '{}');
                let html = '';

                if (options.size) {
                    html += `<strong>Size:</strong> ${options.size}`;
                }
                if (options.color) {
                    if (html) html += ' | ';
                    html += `<strong>Color:</strong> ${options.color}`;
                }

                el.innerHTML = html || 'No options';
            } catch (e) {
                console.warn('Failed to parse options:', e);
            }
        });
    });

    async function cancelOrder(orderId) {
        if (!confirm('Are you sure you want to cancel this order?')) {
            return;
        }

        const reason = prompt('Please tell us why you want to cancel:');

        try {
            const response = await fetch(`/fashionshop/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `reason=${encodeURIComponent(reason || 'No reason')}`
            });

            const data = await response.json();

            if (data.success) {
                alert('Order cancelled successfully');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function reorder(orderId) {
        if (!confirm('Add all items from this order to your cart?')) {
            return;
        }

        try {
            const response = await fetch(`/fashionshop/orders/${orderId}/reorder`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                if (typeof window.refreshCartBadge === 'function') {
                    window.refreshCartBadge();
                }
                window.location.href = '/fashionshop/cart/cart';
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
</body>
</html>