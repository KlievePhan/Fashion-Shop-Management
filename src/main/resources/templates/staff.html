<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Panel - Fashion Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/staff.css}">
    <style>
        /* Toast notification styles */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
        }

        .toast-notification.error {
            background: #dc3545;
        }

        .toast-notification.warning {
            background: #ffc107;
            color: #000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast-notification.hiding {
            animation: slideOut 0.3s ease-out forwards;
        }

        .toast-icon {
            font-size: 24px;
        }

        .toast-message {
            flex: 1;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo">
            <h2>Fashion Staff</h2>
        </div>
        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-section="dashboard">
                <span class="icon">üìä</span>
                Staff Dashboard
            </a>
            <a href="#" class="nav-item" data-section="products">
                <span class="icon">üëï</span>
                Products
            </a>
            <a href="#" class="nav-item" data-section="brands">
                <span class="icon">üè∑Ô∏è</span>
                Brands
            </a>
            <a href="#" class="nav-item" data-section="orders">
                <span class="icon">üì¶</span>
                Orders
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                <div class="header-title-section">
                    <h1 id="pageTitle">Staff Dashboard</h1>
                    <p class="header-subtitle" id="headerSubtitle">Manage products, brands & orders</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-profile">
                    <div class="avatar">S</div>
                    <div class="user-info">
                        <span class="user-name">Staff</span>
                        <span class="user-role">Staff Panel</span>
                    </div>
                    <div class="profile-dropdown">
                        <button class="dropdown-toggle">‚ãÆ</button>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item">
                                <i>üë§</i> Profile
                            </a>
                            <a href="#" class="dropdown-item">
                                <i>‚öôÔ∏è</i> Settings
                            </a>
                            <div class="dropdown-divider"></div>
                            <form th:action="@{/logout}" method="post" style="margin:0;">
                                <button type="submit" class="dropdown-item logout-item">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Staff Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon red">üëï</div>
                    <div class="stat-info">
                        <h3>Total Products</h3>
                        <p class="stat-value" th:text="${#lists.size(products)}">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè∑Ô∏è</div>
                    <div class="stat-info">
                        <h3>Total Brands</h3>
                        <p class="stat-value" th:text="${#lists.size(brands)}">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-info">
                        <h3>Total Orders</h3>
                        <p class="stat-value" th:text="${orders != null ? #lists.size(orders) : 0}">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="products" class="content-section">
            <div class="section-header">
                <h2>Products Management</h2>
                <div class="filter-group">
                    <input type="text"
                           class="filter-select"
                           id="productSearchInput"
                           placeholder="Search by SKU or Title..."
                           style="width: 300px;">
                    <select id="pageSizeSelect" class="filter-select ms-2" style="width: 100px;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="addProductBtn">+ Add Product</button>
            </div>

            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th style="display: none;">ID</th>
                            <th>SKU</th>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        <!-- Filled dynamically by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Product pagination" class="mt-3">
                    <ul class="pagination justify-content-center" id="paginationList">
                        <!-- Filled dynamically by JS -->
                    </ul>
                </nav>
            </div>
        </section>

        <!-- Brands Section -->
        <section id="brands" class="content-section">
            <div class="section-header">
                <h2>Brand Management</h2>
                <button class="btn btn-primary" id="addBrandBtn">+ Add Brand</button>
            </div>

            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Created At</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="brandsTableBody">
                            <tr th:each="brand : ${brands}" th:id="'brand-row-' + ${brand.id}">
                                <td th:text="${brand.id}"></td>
                                <td class="brand-name" th:text="${brand.name}"></td>
                                <td class="brand-slug" th:text="${brand.slug}"></td>
                                <td th:text="${#temporals.format(brand.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                    <div class="action-btns">
                                        <button type="button" class="btn btn-sm btn-secondary edit-brand-btn"
                                            th:data-id="${brand.id}">Edit</button>
                                        <button type="button" class="btn btn-sm btn-danger delete-brand-btn"
                                            th:data-id="${brand.id}" th:data-name="${brand.name}">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Orders Section -->
        <section id="orders" class="content-section">
            <div class="section-header">
                <h2>Orders Management</h2>
                <div class="filter-group">
                    <select class="filter-select" id="orderStatusFilter">
                        <option value="all">All Status</option>
                        <option value="PENDING">Pending</option>
                        <option value="COD_PENDING">COD Pending</option>
                        <option value="PAID">Paid</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Order Code</th>
                            <th>Customer Name</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        <tr th:each="o : ${orders}" th:id="'order-row-' + ${o.id}">
                            <td th:text="${o.id}"></td>
                            <td th:text="${o.orderCode}"></td>
                            <td class="customer-name" th:text="${o.user != null ? o.user.fullName : 'Guest'}"></td>
                            <td th:text="${#temporals.format(o.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td th:text="'$' + ${o.totalAmount}"></td>
                            <td>
                        <span class="badge order-status-badge"
                              th:classappend="${o.status == 'PENDING' or o.status == 'COD_PENDING' ? 'warning' :
                                             (o.status == 'PAID' ? 'success' :
                                             (o.status == 'SHIPPED' or o.status == 'DELIVERED' ? 'info' : 'danger'))}"
                              th:text="${o.status}"></span>
                            </td>
                            <td>
                                <div class="action-btns">
                                    <button type="button"
                                            class="btn btn-sm btn-success update-to-paid-btn"
                                            th:if="${o.status == 'PENDING' or o.status == 'COD_PENDING'}"
                                            th:data-id="${o.id}"
                                            th:data-code="${o.orderCode}">
                                        Mark as Paid
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm btn-danger cancel-order-btn"
                                            th:if="${o.status == 'PENDING' or o.status == 'COD_PENDING'}"
                                            th:data-id="${o.id}"
                                            th:data-code="${o.orderCode}"
                                            th:data-email="${o.user != null ? o.user.email : ''}">
                                        Cancel Order
                                    </button>
                                    <span th:unless="${o.status == 'PENDING' or o.status == 'COD_PENDING'}"
                                          class="text-muted"
                                          style="font-size: 0.85rem;">
                                No actions
                            </span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Brand Modal -->
    <div id="brandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="brandModalTitle">Add New Brand</h2>
                <button class="close-modal" onclick="closeBrandModal()">&times;</button>
            </div>
            <form th:action="@{/staff/brand/save}" method="post" id="brandForm">
                <input type="hidden" id="brandId" name="id">
                <div class="form-group">
                    <label>Brand Name</label>
                    <input type="text" id="brandName" name="name" required maxlength="150"
                        placeholder="e.g., Nike, Adidas">
                </div>
                <div class="form-group">
                    <label>Slug</label>
                    <input type="text" id="brandSlug" name="slug" required maxlength="150"
                        placeholder="e.g., nike, adidas">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal"
                        onclick="closeBrandModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Brand</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CANCEL ORDER MODAL -->
    <div id="cancelOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cancel Order</h2>
                <button class="close-modal" onclick="closeCancelOrderModal()">&times;</button>
            </div>
            <form id="cancelOrderForm">
                <input type="hidden" id="cancelOrderId" name="orderId">
                <div class="form-group">
                    <label>Order Code</label>
                    <input type="text" id="cancelOrderCode" readonly style="background-color: #f3f4f6;">
                </div>
                <div class="form-group">
                    <label>Customer Email</label>
                    <input type="text" id="cancelCustomerEmail" readonly style="background-color: #f3f4f6;">
                    <small style="color: #6b7280; font-size: 0.85rem; display: block; margin-top: 4px;">
                        üìß Notification email will be sent to this address
                    </small>
                </div>
                <div class="form-group">
                    <label>Reason for Cancellation *</label>
                    <select id="cancelReason" name="reason" required class="form-control">
                        <option value="">Select a reason...</option>
                        <option value="Product out of stock">Product out of stock</option>
                        <option value="Technical issue">Technical issue</option>
                        <option value="Payment processing error">Payment processing error</option>
                        <option value="Customer request">Customer request</option>
                        <option value="Inventory discrepancy">Inventory discrepancy</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group" id="customReasonGroup" style="display: none;">
                    <label>Please specify</label>
                    <textarea id="customReason" name="customReason" rows="3"
                              placeholder="Enter detailed reason..."
                              style="width: 100%; padding: 0.65rem 0.8rem; border-radius: 0.65rem; border: 1px solid #d9e6f5;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCancelOrderModal()">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Cancellation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PRODUCT MODAL -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Add New Product</h2>
                <button class="close-modal" onclick="closeProductModal()">X</button>
            </div>

            <form th:action="@{/staff/products/save}" method="post" id="productForm">
                <input type="hidden" id="productId" name="id">

                <div class="form-row">
                    <div class="form-group">
                        <label>SKU *</label>
                        <input type="text" id="productSku" name="sku" required placeholder="e.g., TS-001">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="productActive" name="active">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Product Title *</label>
                    <input type="text" id="productTitle" name="title" required placeholder="e.g., Classic T-Shirt">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="productDescription" name="description" rows="3"
                        placeholder="Product description..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="productCategoryId" name="categoryId" required>
                            <option value="">Select Category</option>
                            <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Brand</label>
                        <select id="productBrandId" name="brandId">
                            <option value="">Optional</option>
                            <option th:each="brand : ${brands}" th:value="${brand.id}" th:text="${brand.name}"></option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Base Price ($) *</label>
                    <input type="number" id="productPrice" name="basePrice" step="0.01" min="0" required
                        placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Image URLs (comma-separated)</label>
                    <textarea id="productImageUrls" name="imageUrls" rows="2"
                        placeholder="https://example.com/img1.jpg, https://example.com/img2.jpg"></textarea>
                </div>

                <div class="form-group">
                    <label>Variants</label>
                    <div id="variantsContainer"></div>
                    <button type="button" class="btn btn-secondary" id="addVariantBtn" style="margin-top:8px;">Add
                        Variant</button>
                </div>
                <input type="hidden" id="variantsJson" name="variantsJson">

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <script th:src="@{/js/staff.js}"></script>

    <script th:inline="javascript">
        const contextPath = /*[[@{/}]]*/ '/';

        // --- 1. UTILITIES ---

        // Toast Notification
        function showToast(message, type = 'success') {
            // X√≥a toast c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh ch·ªìng ch√©o
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†';

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;

            document.body.appendChild(toast);

            // Animation CSS handling (Assuming CSS exists)
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Helper: Toggle Modal visibility
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = show ? 'flex' : 'none';
                if (show) modal.classList.add('active'); // For product modal style compatibility
                else modal.classList.remove('active');
            }
        }

        // --- 2. NAVIGATION & PERSISTENCE ---

        document.addEventListener('DOMContentLoaded', function () {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('pageTitle');

            // L·∫•y tab ƒë√£ l∆∞u t·ª´ localStorage, m·∫∑c ƒë·ªãnh l√† dashboard
            const activeSectionId = localStorage.getItem('staffActiveTab') || 'dashboard';

            // H√†m k√≠ch ho·∫°t tab
            function activateTab(sectionId) {
                // Update Nav state
                navItems.forEach(nav => {
                    if (nav.dataset.section === sectionId) nav.classList.add('active');
                    else nav.classList.remove('active');
                });

                // Update Section visibility
                sections.forEach(section => {
                    if (section.id === sectionId) section.classList.add('active');
                    else section.classList.remove('active');
                });

                // Update Title
                const activeNav = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
                if (activeNav) pageTitle.textContent = activeNav.textContent.trim();

                // Save to storage
                localStorage.setItem('staffActiveTab', sectionId);
            }

            // Kh·ªüi ch·∫°y tab ban ƒë·∫ßu
            activateTab(activeSectionId);

            // S·ª± ki·ªán click menu
            navItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    activateTab(this.dataset.section);
                });
            });
        });

        // --- 3. BRAND MANAGEMENT (ƒê√£ s·ª≠a l·ªói Reload) ---

        // Open Add Brand Modal
        document.getElementById('addBrandBtn')?.addEventListener('click', function () {
            document.getElementById('brandModalTitle').textContent = 'Add New Brand';
            document.getElementById('brandForm').reset();
            document.getElementById('brandId').value = ''; // ID r·ªóng = Add new
            toggleModal('brandModal', true);
        });

        // Auto Generate Slug
        document.getElementById('brandName')?.addEventListener('input', function (e) {
            const slug = e.target.value.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            document.getElementById('brandSlug').value = slug;
        });

        // Close Brand Modal
        window.closeBrandModal = function () { toggleModal('brandModal', false); };

        // Edit Brand: Fetch Data
        window.editBrand = function (id) {
            const btn = document.querySelector(`.edit-brand-btn[data-id="${id}"]`);
            if (btn) btn.textContent = '...'; // Loading indicator

            fetch(contextPath + 'staff/brand/' + id, { headers: { 'Accept': 'application/json' } })
                .then(r => {
                    if (!r.ok) throw new Error('Brand not found');
                    return r.json();
                })
                .then(brand => {
                    document.getElementById('brandModalTitle').textContent = 'Edit Brand';
                    document.getElementById('brandId').value = brand.id;
                    document.getElementById('brandName').value = brand.name;
                    document.getElementById('brandSlug').value = brand.slug;
                    toggleModal('brandModal', true);
                })
                .catch(err => showToast(err.message, 'error'))
                .finally(() => { if (btn) btn.textContent = 'Edit'; });
        }

        // *** BRAND SUBMIT HANDLER (CORE FIX) ***
        document.getElementById('brandForm')?.addEventListener('submit', function (e) {
            e.preventDefault(); // Ch·∫∑n reload form m·∫∑c ƒë·ªãnh

            const form = this;
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');

            // UI Loading state
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const isEdit = formData.get('id') && formData.get('id') !== '';

            fetch(contextPath + 'staff/brand/save', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
                .then(response => {
                    if (response.ok) {
                        toggleModal('brandModal', false);

                        if (isEdit) {
                            // LOGIC C·∫¨P NH·∫¨T GIAO DI·ªÜN KH√îNG RELOAD
                            const id = formData.get('id');
                            const name = formData.get('name');
                            const slug = formData.get('slug');

                            // T√¨m d√≤ng trong b·∫£ng d·ª±a v√†o ID (ƒë√£ th√™m ·ªü B∆∞·ªõc 1)
                            const row = document.getElementById('brand-row-' + id);
                            if (row) {
                                row.querySelector('.brand-name').textContent = name;
                                row.querySelector('.brand-slug').textContent = slug;

                                // Hi·ªáu ·ª©ng nh√°y m√†u xanh ƒë·ªÉ b√°o hi·ªáu ƒë√£ s·ª≠a
                                row.style.backgroundColor = '#d4edda';
                                row.style.transition = 'background-color 0.5s';
                                setTimeout(() => row.style.backgroundColor = '', 1000);
                            }
                            showToast('Brand updated successfully!', 'success');
                        } else {
                            // N·∫øu l√† Th√™m m·ªõi (Add), ta v·∫´n n√™n reload ƒë·ªÉ l·∫•y ID m·ªõi t·ª´ server
                            // (ho·∫∑c append row n·∫øu backend tr·∫£ v·ªÅ JSON object ƒë·∫ßy ƒë·ªß)
                            showToast('New brand added! Reloading...', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    } else {
                        throw new Error('Failed to save brand');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Save failed. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        });

        // --- 4. PRODUCT MANAGEMENT ---

        // ==================== DYNAMIC PAGINATION FOR PRODUCTS ====================
        let currentPage = 0;
        let currentSize = 10;
        let currentKeyword = '';

        // Simple debounce helper
        const debounce = (func, delay) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        };

        function loadProducts(page = 0, size = 10, keyword = '') {
            currentPage = page;
            currentSize = size;
            currentKeyword = keyword;

            const params = new URLSearchParams({
                page: page,
                size: size
            });
            if (keyword) params.append('keyword', keyword);

            fetch(`${contextPath}staff/products/paginated?${params}`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed');
                    return res.json();
                })
                .then(data => {
                    const tbody = document.getElementById('productsTableBody');
                    tbody.innerHTML = '';

                    data.content.forEach(p => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="display: none;">${p.id}</td>
                            <td>${p.sku || ''}</td>
                            <td><img src="${p.primaryImageUrl || ''}" alt="img"
                                     style="width:50px;height:50px;object-fit:cover;border-radius:4px;"></td>
                            <td>${p.title || ''}</td>
                            <td>${p.category ? p.category.name : 'N/A'}</td>
                            <td>${p.brand ? p.brand.name : 'N/A'}</td>
                            <td>$${Number(p.basePrice || 0).toFixed(2)}</td>
                            <td><span class="badge ${p.active ? 'success' : 'danger'}">${p.active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="editProduct(${p.id})">Edit</button>
                                    <button type="button"
                                            class="btn btn-sm toggle-active-btn ${p.active ? 'btn-warning' : 'btn-success'}"
                                            data-id="${p.id}" data-active="${p.active}">
                                        <span>${p.active ? 'Deactivate' : 'Activate'}</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger delete-product-btn"
                                            data-id="${p.id}" data-title="${p.title}">Delete</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    renderPagination(data.currentPage, data.totalPages);
                    // Update total products counter on dashboard
                    const counter = document.querySelectorAll('.stat-card .stat-value')[0];
                    if (counter) counter.textContent = data.totalElements;
                })
                .catch(() => showToast('Failed to load products', 'error'));
        }

        function renderPagination(current, total) {
            const ul = document.getElementById('paginationList');
            ul.innerHTML = '';

            // Previous
            const prev = `<li class="page-item ${current === 0 ? 'disabled' : ''}">
                          <a class="page-link" href="#" data-page="${current - 1}">Previous</a></li>`;
            ul.innerHTML += prev;

            // Pages (show max 7 buttons, ellipsis if needed)
            let start = Math.max(0, current - 3);
            let end   = Math.min(total, current + 4);
            if (start > 0) ul.innerHTML += `<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>`;
            for (let i = start; i < end; i++) {
                ul.innerHTML += `<li class="page-item ${i === current ? 'active' : ''}">
                                 <a class="page-link" href="#" data-page="${i}">${i + 1}</a></li>`;
            }
            if (end < total) ul.innerHTML += `<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>`;

            // Next
            const next = `<li class="page-item ${current >= total - 1 ? 'disabled' : ''}">
                          <a class="page-link" href="#" data-page="${current + 1}">Next</a></li>`;
            ul.innerHTML += next;
        }

        // Pagination click
        document.getElementById('paginationList').addEventListener('click', e => {
            const link = e.target.closest('.page-link');
            if (link && !link.parentElement.classList.contains('disabled')) {
                e.preventDefault();
                const page = parseInt(link.dataset.page);
                loadProducts(page, currentSize, currentKeyword);
            }
        });

        // Search with debounce
        document.getElementById('productSearchInput').addEventListener('input', debounce(e => {
            loadProducts(0, currentSize, e.target.value.trim());
        }, 400));

        // Page size change
        document.getElementById('pageSizeSelect').addEventListener('change', e => {
            loadProducts(0, parseInt(e.target.value), currentKeyword);
        });

        // Load products when the Products tab becomes active
        document.querySelector('[data-section="products"]').addEventListener('click', () => {
            if (document.getElementById('products').classList.contains('active')) {
                loadProducts(0, currentSize, currentKeyword);
            }
        });

        // Initial load when page finishes loading (or when Products tab is first opened)
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('products').classList.contains('active')) {
                loadProducts();
            }
        });

        // Toggle Active
        window.toggleProductActive = function (btn) {
            const productId = btn.dataset.id;
            const isActive = btn.dataset.active === 'true';
            btn.disabled = true;

            fetch(contextPath + 'staff/products/' + productId + '/toggle-active', { method: 'POST' })
                .then(res => {
                    if (!res.ok) throw new Error('Failed');

                    const newActive = !isActive;
                    btn.dataset.active = newActive;

                    // Update Button Style
                    btn.classList.toggle('btn-warning', newActive);
                    btn.classList.toggle('btn-success', !newActive);
                    btn.querySelector('span').textContent = newActive ? 'Deactivate' : 'Activate';

                    // Update Badge
                    const row = btn.closest('tr');
                    const badge = row.querySelector('.badge');
                    badge.className = `badge ${newActive ? 'success' : 'danger'}`;
                    badge.textContent = newActive ? 'Active' : 'Inactive';

                    showToast(`Product ${newActive ? 'activated' : 'deactivated'}!`, 'success');
                })
                .catch(() => showToast('Error updating status', 'error'))
                .finally(() => btn.disabled = false);
        };

        // Delete Product
        window.deleteProduct = function (btn) {
            const id = btn.dataset.id;
            const title = btn.dataset.title;

            if (!confirm(`Delete product "${title}"?`)) return;

            btn.disabled = true;
            btn.textContent = '...';

            fetch(contextPath + 'staff/products/' + id + '/delete', { method: 'POST' })
                .then(res => {
                    if (!res.ok) throw new Error('Failed');

                    const row = btn.closest('tr');
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);

                    // Update counter
                    const counter = document.querySelector('.stat-card .stat-value');
                    if (counter) counter.textContent = parseInt(counter.textContent) - 1;

                    showToast('Product deleted!', 'success');
                })
                .catch(() => {
                    showToast('Delete failed', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                });
        };

        // Product Search Functionality
        document.getElementById('productSearchInput')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const tableBody = document.getElementById('productsTableBody');
            const rows = tableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const sku = row.cells[1]?.textContent.toLowerCase() || '';
                const title = row.cells[3]?.textContent.toLowerCase() || '';

                if (sku.includes(searchTerm) || title.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Product Modal & Variants
        window.closeProductModal = function () { toggleModal('productModal', false); };

        document.getElementById('addProductBtn')?.addEventListener('click', function () {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('variantsContainer').innerHTML = '';
            toggleModal('productModal', true);
        });

        function addVariantRow(data = { size: '', color: '', sku: '', price: '', stock: 0 }) {
            const container = document.getElementById('variantsContainer');
            const row = document.createElement('div');
            row.className = 'variant-row';
            row.innerHTML = `
                <input type="text" class="variant-size" placeholder="Size" value="${data.size}">
                <input type="text" class="variant-color" placeholder="Color" value="${data.color}">
                <input type="text" class="variant-sku" placeholder="Variant SKU" value="${data.sku}">
                <input type="number" step="0.01" class="variant-price" placeholder="Price" value="${data.price}">
                <input type="number" class="variant-stock" placeholder="Stock" value="${data.stock}">
                <button type="button" class="remove-variant">Remove</button>
            `;
            container.appendChild(row);
            row.querySelector('.remove-variant').addEventListener('click', () => row.remove());
        }

        document.getElementById('addVariantBtn')?.addEventListener('click', () => addVariantRow());

        // Product Submit: Gather JSON
        // Product Submit: Gather JSON + AJAX gi·ªëng Brands
        document.getElementById('productForm')?.addEventListener('submit', function (e) {
            e.preventDefault(); // kh√¥ng cho form redirect m·∫∑c ƒë·ªãnh

            const form = this;

            // 1. Build variantsJson
            const variants = Array.from(document.querySelectorAll('.variant-row')).map(row => {
                const size = row.querySelector('.variant-size').value.trim();
                const color = row.querySelector('.variant-color').value.trim();
                if (!size && !color) return null;

                return {
                    sku: row.querySelector('.variant-sku').value.trim(),
                    attributeJson: JSON.stringify({ size, color }),
                    price: row.querySelector('.variant-price').value || '',
                    stock: row.querySelector('.variant-stock').value || ''
                };
            }).filter(v => v !== null);

            document.getElementById('variantsJson').value = JSON.stringify(variants);

            // 2. G·ª≠i form b·∫±ng fetch
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            const isEdit = formData.get('id') && formData.get('id') !== '';

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            fetch(contextPath + 'staff/products/save', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to save product');

                    // ƒê√≥ng modal
                    toggleModal('productModal', false);

                    // L∆∞u tab hi·ªán t·∫°i l√† Products ƒë·ªÉ sau reload v·∫´n ·ªü ƒë√≥
                    localStorage.setItem('staffActiveTab', 'products');

                    // Th√¥ng b√°o
                    showToast(isEdit ? 'Product updated successfully!' : 'New product created!', 'success');

                    // Reload l·∫°i trang ƒë·ªÉ load l·∫°i list product
                    setTimeout(() => window.location.reload(), 800);
                })
                .catch(err => {
                    console.error(err);
                    showToast('Save product failed. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        });


        // Edit Product Fetch
        window.editProduct = function (id) {
            fetch(contextPath + 'staff/products/' + id, { headers: { 'Accept': 'application/json' } })
                .then(r => r.ok ? r.json() : Promise.reject('Error'))
                .then(p => {
                    document.getElementById('productModalTitle').textContent = 'Edit Product';
                    document.getElementById('productId').value = p.id;
                    document.getElementById('productSku').value = p.sku || '';
                    document.getElementById('productTitle').value = p.title || '';
                    document.getElementById('productDescription').value = p.description || '';
                    document.getElementById('productCategoryId').value = p.category?.id || '';
                    document.getElementById('productBrandId').value = p.brand?.id || '';
                    document.getElementById('productPrice').value = p.basePrice || '';
                    document.getElementById('productActive').value = p.active ? 'true' : 'false';
                    document.getElementById('productImageUrls').value = p.images ? p.images.map(i => i.url).join(', ') : '';

                    // Variants
                    const container = document.getElementById('variantsContainer');
                    container.innerHTML = 'Loading variants...';

                    fetch(contextPath + 'staff/products/' + id + '/variants')
                        .then(r => r.json())
                        .then(variants => {
                            container.innerHTML = '';
                            variants.forEach(v => {
                                let attr = {};
                                try { attr = JSON.parse(v.attributeJson || '{}'); } catch (e) { }
                                addVariantRow({
                                    size: attr.size || '', color: attr.color || '',
                                    sku: v.sku || '', price: v.price || '', stock: v.stock || 0
                                });
                            });
                        });

                    toggleModal('productModal', true);
                })
                .catch(err => showToast('Failed to load product', 'error'));
        }

        // --- 5. GLOBAL EVENT DELEGATION (Cleaner way) ---
        document.addEventListener('click', function (e) {
            // Brand Edit
            if (e.target.closest('.edit-brand-btn')) {
                window.editBrand(e.target.closest('.edit-brand-btn').dataset.id);
            }
            // Brand Delete
            if (e.target.closest('.delete-brand-btn')) {
                const btn = e.target.closest('.delete-brand-btn');
                const id = btn.dataset.id;
                const name = btn.dataset.name;
                if (confirm(`Delete brand "${name}"?`)) {
                    // Logic delete t∆∞∆°ng t·ª± product, c√≥ th·ªÉ t√°ch h√†m ri√™ng n·∫øu mu·ªën
                    btn.disabled = true;
                    fetch(contextPath + 'staff/brand/' + id + '/delete', { method: 'POST' })
                        .then(r => {
                            if (r.ok) {
                                const row = document.getElementById('brand-row-' + id); // S·ª≠ d·ª•ng ID ƒë√£ th√™m ·ªü b∆∞·ªõc 1
                                if (row) row.remove();
                                showToast('Brand deleted', 'success');
                            } else throw new Error();
                        })
                        .catch(() => { showToast('Error deleting brand', 'error'); btn.disabled = false; });
                }
            }
            // Product Actions
            if (e.target.closest('.toggle-active-btn')) {
                e.preventDefault();
                window.toggleProductActive(e.target.closest('.toggle-active-btn'));
            }
            if (e.target.closest('.delete-product-btn')) {
                e.preventDefault();
                window.deleteProduct(e.target.closest('.delete-product-btn'));
            }
        });

        // Dropdown Profile
        document.querySelector('.dropdown-toggle')?.addEventListener('click', function (e) {
            e.stopPropagation();
            this.nextElementSibling.classList.toggle('show');
        });
        document.addEventListener('click', function () {
            document.querySelector('.dropdown-menu')?.classList.remove('show');
        });

        // --- 5. ORDER MANAGEMENT ---

        // Update Order to Paid
        function updateOrderToPaid(btn) {
            const orderId = btn.dataset.id;
            const orderCode = btn.dataset.code;

            if (!confirm(`Mark order ${orderCode} as PAID?`)) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Updating...';

            fetch(contextPath + 'staff/orders/' + orderId + '/update-to-paid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(data => {
                            throw new Error(data.message || 'Update failed');
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update badge in the table
                        const row = document.getElementById('order-row-' + orderId);
                        if (row) {
                            const badge = row.querySelector('.order-status-badge');
                            badge.className = 'badge order-status-badge success';
                            badge.textContent = data.newStatus; // Will be 'PAID'

                            // Remove the button and show "No actions"
                            const actionsCell = row.querySelector('.action-btns');
                            actionsCell.innerHTML = '<span class="text-muted" style="font-size: 0.85rem;">No actions</span>';

                            // Highlight effect
                            row.style.backgroundColor = '#d4edda';
                            row.style.transition = 'background-color 0.5s';
                            setTimeout(() => row.style.backgroundColor = '', 1500);
                        }

                        showToast(data.message || 'Order updated successfully!', 'success');
                    } else {
                        throw new Error(data.message || 'Update failed');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    showToast(err.message || 'Failed to update order status', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        }

        // Order Status Filter - Updated to handle uppercase status values
        document.getElementById('orderStatusFilter')?.addEventListener('change', function(e) {
            const selectedStatus = e.target.value; // Keep original case (uppercase)
            const tableBody = document.getElementById('ordersTableBody');
            const rows = tableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const statusBadge = row.querySelector('.order-status-badge');
                if (!statusBadge) return;

                const rowStatus = statusBadge.textContent.trim(); // Keep original case

                if (selectedStatus === 'all' || rowStatus === selectedStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // --- 6. ORDER CANCELLATION ---

        // Cancel Order Modal
        window.openCancelOrderModal = function(orderId, orderCode, customerEmail) {
            document.getElementById('cancelOrderId').value = orderId;
            document.getElementById('cancelOrderCode').value = orderCode;
            document.getElementById('cancelCustomerEmail').value = customerEmail || 'N/A (Guest order)';
            document.getElementById('cancelReason').value = '';
            document.getElementById('customReason').value = '';
            document.getElementById('customReasonGroup').style.display = 'none';
            toggleModal('cancelOrderModal', true);
        };

        window.closeCancelOrderModal = function() {
            toggleModal('cancelOrderModal', false);
        };

        // Show custom reason field when "Other" is selected
        document.getElementById('cancelReason')?.addEventListener('change', function(e) {
            const customReasonGroup = document.getElementById('customReasonGroup');
            if (e.target.value === 'Other') {
                customReasonGroup.style.display = 'block';
                document.getElementById('customReason').required = true;
            } else {
                customReasonGroup.style.display = 'none';
                document.getElementById('customReason').required = false;
            }
        });

        // Cancel Order Form Submit
        document.getElementById('cancelOrderForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            const orderId = document.getElementById('cancelOrderId').value;
            const reasonSelect = document.getElementById('cancelReason');
            const customReason = document.getElementById('customReason').value;

            let reason = reasonSelect.value;
            if (reason === 'Other' && customReason.trim()) {
                reason = 'Other: ' + customReason.trim();
            }

            if (!reason || reason === '') {
                showToast('Please select or specify a reason for cancellation', 'error');
                return;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Cancelling...';

            fetch(contextPath + 'staff/orders/' + orderId + '/cancel?reason=' + encodeURIComponent(reason), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(data => {
                            throw new Error(data.message || 'Cancellation failed');
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update badge in the table
                        const row = document.getElementById('order-row-' + orderId);
                        if (row) {
                            const badge = row.querySelector('.order-status-badge');
                            badge.className = 'badge order-status-badge danger';
                            badge.textContent = data.newStatus; // Will be 'CANCELLED'

                            // Remove action buttons and show "No actions"
                            const actionsCell = row.querySelector('.action-btns');
                            actionsCell.innerHTML = '<span class="text-muted" style="font-size: 0.85rem;">No actions</span>';

                            // Highlight effect
                            row.style.backgroundColor = '#fee2e2';
                            row.style.transition = 'background-color 0.5s';
                            setTimeout(() => row.style.backgroundColor = '', 1500);
                        }

                        closeCancelOrderModal();
                        showToast(data.message || 'Order cancelled successfully! Customer has been notified.', 'success');
                    } else {
                        throw new Error(data.message || 'Cancellation failed');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    showToast(err.message || 'Failed to cancel order', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
        });

        // --- 7. GLOBAL EVENT DELEGATION (Cleaner way) ---
        document.addEventListener('click', function (e) {
            // ... other handlers ...

            // Order Update to Paid - THIS MUST BE PRESENT
            if (e.target.closest('.update-to-paid-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.update-to-paid-btn');
                updateOrderToPaid(btn);
            }

            // Order Cancel
            if (e.target.closest('.cancel-order-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.cancel-order-btn');
                const orderId = btn.dataset.id;
                const orderCode = btn.dataset.code;
                const customerEmail = btn.dataset.email || '';
                openCancelOrderModal(orderId, orderCode, customerEmail);
            }
        });
    </script>

</body>

</html>