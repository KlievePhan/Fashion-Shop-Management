<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Panel - Fashion Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/staff.css}">
</head>
<body>
<!-- Sidebar Navigation -->
<aside class="sidebar">
    <div class="logo">
        <h2>Fashion Staff</h2>
    </div>
    <nav class="nav-menu">
        <a href="#" class="nav-item active" data-section="dashboard">
            <span class="icon">üìä</span>
            Staff Dashboard
        </a>
        <a href="#" class="nav-item" data-section="products">
            <span class="icon">üëï</span>
            Products
        </a>
        <a href="#" class="nav-item" data-section="brands">
            <span class="icon">üè∑Ô∏è</span>
            Brands
        </a>
        <a href="#" class="nav-item" data-section="orders">
            <span class="icon">üì¶</span>
            Orders
        </a>
    </nav>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="header-title-section">
                <h1 id="pageTitle">Staff Dashboard</h1>
                <p class="header-subtitle" id="headerSubtitle">Manage products, brands & orders</p>
            </div>
        </div>
        <div class="header-right">
            <div class="search-bar">
                <input type="text" placeholder="Search products, orders..." id="searchInput">
                <i class="search-icon">üîç</i>
            </div>

            <div class="user-profile">
                <div class="avatar">S</div>
                <div class="user-info">
                    <span class="user-name">Staff</span>
                    <span class="user-role">Staff Panel</span>
                </div>
                <div class="profile-dropdown">
                    <button class="dropdown-toggle">‚ãÆ</button>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item">
                            <i>üë§</i> Profile
                        </a>
                        <div class="dropdown-divider"></div>
                        <form th:action="@{/logout}" method="post" style="margin:0;">
                            <button type="submit" class="dropdown-item logout-item">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Staff Dashboard Section -->
    <section id="dashboard" class="content-section active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon red">üëï</div>
                <div class="stat-info">
                    <h3>Total Products</h3>
                    <p class="stat-value" th:text="${#lists.size(products)}">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-info">
                    <h3>Total Brands</h3>
                    <p class="stat-value" th:text="${#lists.size(brands)}">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-info">
                    <h3>Total Orders</h3>
                    <p class="stat-value" th:text="${orders != null ? #lists.size(orders) : 0}">0</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Products Section -->
    <section id="products" class="content-section">
        <div class="section-header">
            <h2>Products Management</h2>
            <div class="filter-group">
                <select class="filter-select" id="productCategoryFilter">
                    <option value="all">All Categories</option>
                    <option value="man">Man</option>
                    <option value="woman">Woman</option>
                    <option value="unisex">Unisex</option>
                </select>
            </div>
            <button class="btn btn-primary" id="addProductBtn">+ Add Product</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th style="display: none;">ID</th>
                        <th>SKU</th>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Brand</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    <tr th:each="product : ${products}">
                        <td style="display: none;" th:text="${product.id}"></td>
                        <td th:text="${product.sku}"></td>
                        <td>
                            <img th:src="${product.primaryImageUrl}"
                                 alt="Product"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                        </td>
                        <td th:text="${product.title}"></td>
                        <td th:text="${product.category != null ? product.category.name : 'N/A'}"></td>
                        <td th:text="${product.brand != null ? product.brand.name : 'N/A'}"></td>
                        <td th:text="'$' + ${product.basePrice}"></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${product.active ? 'success' : 'danger'}"
                                  th:text="${product.active ? 'Active' : 'Inactive'}"></span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button type="button"
                                        class="btn btn-sm btn-secondary"
                                        th:onclick="'editProduct(\'' + ${product.id} + '\')'">
                                    Edit
                                </button>
                                <form th:action="@{/staff/products/{id}/toggle-active(id=${product.id})}"
                                      method="post"
                                      style="display:inline;">
                                    <button type="submit"
                                            class="btn btn-sm"
                                            th:classappend="${product.active ? 'btn-warning' : 'btn-success'}">
                                        <span th:text="${product.active ? 'Deactivate' : 'Activate'}"></span>
                                    </button>
                                </form>
                                <form th:action="@{/staff/products/{id}/delete(id=${product.id})}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('Delete this product?')">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Brands Section -->
    <section id="brands" class="content-section">
        <div class="section-header">
            <h2>Brand Management</h2>
            <button class="btn btn-primary" id="addBrandBtn">+ Add Brand</button>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Slug</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="brand : ${brands}">
                        <td th:text="${brand.id}"></td>
                        <td th:text="${brand.name}"></td>
                        <td th:text="${brand.slug}"></td>
                        <td th:text="${#temporals.format(brand.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm btn-secondary"
                                        th:onclick="'editBrand(' + ${brand.id} + ')'">Edit</button>
                                <form th:action="@{/staff/brand/{id}/delete(id=${brand.id})}" method="post"
                                      style="display:inline;"
                                      onsubmit="return confirm('Are you sure you want to delete this brand?')">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Orders Section -->
    <section id="orders" class="content-section">
        <div class="section-header">
            <h2>Orders Management</h2>
            <div class="filter-group">
                <select class="filter-select" id="orderStatus">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="shipped">Shipped</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTable">
                    <tr th:each="o : ${orders}">
                        <td th:text="${o.id}"></td>
                        <td th:text="${o.user != null ? o.user.fullName : 'N/A'}"></td>
                        <td th:text="${#temporals.format(o.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                        <td th:text="'$' + ${o.totalAmount}"></td>
                        <td th:text="${o.status}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<!-- Brand Modal -->
<div id="brandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="brandModalTitle">Add New Brand</h2>
            <button class="close-modal" onclick="closeBrandModal()">&times;</button>
        </div>
        <form th:action="@{/staff/brand/save}" method="post" id="brandForm">
            <input type="hidden" id="brandId" name="id">
            <div class="form-group">
                <label>Brand Name</label>
                <input type="text" id="brandName" name="name" required maxlength="150" placeholder="e.g., Nike, Adidas">
            </div>
            <div class="form-group">
                <label>Slug</label>
                <input type="text" id="brandSlug" name="slug" required maxlength="150"
                       placeholder="e.g., nike, adidas">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal" onclick="closeBrandModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Brand</button>
            </div>
        </form>
    </div>
</div>

<!-- PRODUCT MODAL -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="productModalTitle">Add New Product</h2>
            <button class="close-modal" onclick="closeProductModal()">X</button>
        </div>

        <form th:action="@{/staff/products/save}" method="post" id="productForm">
            <input type="hidden" id="productId" name="id">

            <div class="form-row">
                <div class="form-group">
                    <label>SKU *</label>
                    <input type="text" id="productSku" name="sku" required placeholder="e.g., TS-001">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="productActive" name="active">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Product Title *</label>
                <input type="text" id="productTitle" name="title" required placeholder="e.g., Classic T-Shirt">
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" name="description" rows="3"
                          placeholder="Product description..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Category *</label>
                    <select id="productCategoryId" name="categoryId" required>
                        <option value="">Select Category</option>
                        <option th:each="cat : ${categories}"
                                th:value="${cat.id}"
                                th:text="${cat.name}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Brand</label>
                    <select id="productBrandId" name="brandId">
                        <option value="">Optional</option>
                        <option th:each="brand : ${brands}"
                                th:value="${brand.id}"
                                th:text="${brand.name}"></option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Base Price ($) *</label>
                <input type="number" id="productPrice" name="basePrice"
                       step="0.01" min="0" required placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Image URLs (comma-separated)</label>
                <textarea id="productImageUrls" name="imageUrls" rows="2"
                          placeholder="https://example.com/img1.jpg, https://example.com/img2.jpg"></textarea>
            </div>

            <div class="form-group">
                <label>Variants</label>
                <div id="variantsContainer"></div>
                <button type="button" class="btn btn-secondary" id="addVariantBtn"
                        style="margin-top:8px;">Add Variant</button>
            </div>
            <input type="hidden" id="variantsJson" name="variantsJson">

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        onclick="closeProductModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Product</button>
            </div>
        </form>
    </div>
</div>

<script th:src="@{/js/staff.js}"></script>

<script th:inline="javascript">
    const contextPath = /*[[@{/}]]*/ '/';

    // Navigation
    document.addEventListener('DOMContentLoaded', function () {
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.content-section');
        const pageTitle = document.getElementById('pageTitle');

        navItems.forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const targetSection = this.dataset.section;

                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                sections.forEach(section => section.classList.remove('active'));
                document.getElementById(targetSection).classList.add('active');

                pageTitle.textContent = this.textContent.trim();
            });
        });
    });

    // Brand
    document.getElementById('addBrandBtn')?.addEventListener('click', function () {
        document.getElementById('brandModalTitle').textContent = 'Add New Brand';
        document.getElementById('brandForm').reset();
        document.getElementById('brandId').value = '';
        document.getElementById('brandModal').style.display = 'flex';
    });

    function closeBrandModal() {
        document.getElementById('brandModal').style.display = 'none';
    }

    function editBrand(id) {
        fetch(contextPath + 'staff/brand/' + id, {
            headers: {'Accept': 'application/json'}
        })
            .then(r => {
                if (!r.ok) throw new Error('Brand not found');
                return r.json();
            })
            .then(brand => {
                document.getElementById('brandModalTitle').textContent = 'Edit Brand';
                document.getElementById('brandId').value = brand.id;
                document.getElementById('brandName').value = brand.name;
                document.getElementById('brandSlug').value = brand.slug;
                document.getElementById('brandModal').style.display = 'flex';
            })
            .catch(err => alert(err.message));
    }

    document.getElementById('brandName')?.addEventListener('input', function (e) {
        const slug = e.target.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        document.getElementById('brandSlug').value = slug;
    });

    // Product modal + variants
    document.getElementById('addProductBtn')?.addEventListener('click', function () {
        document.getElementById('productModalTitle').textContent = 'Add New Product';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('variantsContainer').innerHTML = '';
        document.getElementById('productModal').classList.add('active');
    });

    function closeProductModal() {
        document.getElementById('productModal').classList.remove('active');
    }

    function addVariantRow(data = {size: '', color: '', sku: '', price: '', stock: 0}) {
        const container = document.getElementById('variantsContainer');
        const row = document.createElement('div');
        row.className = 'variant-row';
        row.innerHTML = `
            <input type="text" class="variant-size" placeholder="Size" value="${data.size}">
            <input type="text" class="variant-color" placeholder="Color" value="${data.color}">
            <input type="text" class="variant-sku" placeholder="Variant SKU" value="${data.sku}">
            <input type="number" step="0.01" class="variant-price" placeholder="Price" value="${data.price}">
            <input type="number" class="variant-stock" placeholder="Stock" value="${data.stock}">
            <button type="button" class="remove-variant">Remove</button>
        `;
        container.appendChild(row);
        row.querySelector('.remove-variant').addEventListener('click', () => row.remove());
    }

    document.getElementById('addVariantBtn')?.addEventListener('click', () => addVariantRow());

    // On submit ‚Üí build variantsJson
    document.getElementById('productForm')?.addEventListener('submit', function () {
        const variants = [];
        document.querySelectorAll('.variant-row').forEach(row => {
            const size = row.querySelector('.variant-size').value.trim();
            const color = row.querySelector('.variant-color').value.trim();
            const sku = row.querySelector('.variant-sku').value.trim();
            const price = row.querySelector('.variant-price').value;
            const stock = row.querySelector('.variant-stock').value;
            if (size || color) {
                variants.push({
                    sku: sku,
                    attributeJson: JSON.stringify({size, color}),
                    price: price || '',
                    stock: stock || ''
                });
            }
        });
        document.getElementById('variantsJson').value = JSON.stringify(variants);
    });

    function editProduct(id) {
        fetch(contextPath + 'staff/products/' + id, {
            headers: {'Accept': 'application/json'}
        })
            .then(r => {
                if (!r.ok) throw new Error('Product not found');
                return r.json();
            })
            .then(p => {
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = p.id;
                document.getElementById('productSku').value = p.sku || '';
                document.getElementById('productTitle').value = p.title || '';
                document.getElementById('productDescription').value = p.description || '';
                document.getElementById('productCategoryId').value = p.category?.id || '';
                document.getElementById('productBrandId').value = p.brand?.id || '';
                document.getElementById('productPrice').value = p.basePrice || '';
                document.getElementById('productActive').value = p.active ? 'true' : 'false';

                const imgs = p.images ? p.images.map(i => i.url).join(', ') : '';
                document.getElementById('productImageUrls').value = imgs;

                const container = document.getElementById('variantsContainer');
                container.innerHTML = '';
                fetch(contextPath + 'staff/products/' + id + '/variants')
                    .then(r => r.json())
                    .then(variants => {
                        variants.forEach(v => {
                            let attr = {};
                            try {
                                attr = JSON.parse(v.attributeJson || '{}');
                            } catch (e) {}
                            addVariantRow({
                                size: attr.size || '',
                                color: attr.color || '',
                                sku: v.sku || '',
                                price: v.price || '',
                                stock: v.stock || 0
                            });
                        });
                    });

                document.getElementById('productModal').classList.add('active');
            })
            .catch(err => alert(err.message));
    }

    // filter by category
    document.getElementById('productCategoryFilter')?.addEventListener('change', function (e) {
        const cat = e.target.value;

        if (cat === 'all') {
            location.href = contextPath + 'staff#products';
            return;
        }

        fetch(contextPath + 'staff/products/filter?category=' + cat, {
            headers: {'Accept': 'application/json'}
        })
            .then(r => r.json())
            .then(list => {
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = list.map(p => `
                    <tr>
                        <td style="display:none;">${p.id}</td>
                        <td>${p.sku || 'N/A'}</td>
                        <td>
                            <img src="${p.primaryImageUrl || '/images/default.jpg'}"
                                 style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                        </td>
                        <td>${p.title}</td>
                        <td>${p.category ? p.category.name : 'N/A'}</td>
                        <td>${p.brand ? p.brand.name : 'N/A'}</td>
                        <td>$${p.basePrice}</td>
                        <td>
                            <span class="badge ${p.active ? 'success' : 'danger'}">
                                ${p.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button type="button" class="btn btn-sm btn-secondary"
                                        onclick="editProduct('${p.id}')">Edit</button>
                                <form action="${contextPath}staff/products/${p.id}/toggle-active"
                                      method="post" style="display:inline;">
                                    <button type="submit"
                                            class="btn btn-sm ${p.active ? 'btn-warning' : 'btn-success'}">
                                        ${p.active ? 'Deactivate' : 'Activate'}
                                    </button>
                                </form>
                                <form action="${contextPath}staff/products/${p.id}/delete"
                                      method="post" style="display:inline;"
                                      onsubmit="return confirm('Delete this product?')">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(err => console.error(err));
    });

    window.editBrand = editBrand;
    window.editProduct = editProduct;
    window.closeProductModal = closeProductModal;
    window.closeBrandModal = closeBrandModal;
</script>
</body>
</html>
